<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Fac√ß√£o Control - Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #2c3e50 0%, #34495e 50%, #2c3e50 100%);
            min-height: 100vh;
            position: relative;
            overflow-x: hidden;
            color: #ecf0f1;
        }

        body::before {
            content: '';
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 800px;
            height: 800px;
            background-image: url('/static/yin_yang_familia.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.03;
            filter: blur(2px);
            z-index: 0;
            pointer-events: none;
        }

        .header {
            background: rgba(44, 62, 80, 0.95);
            backdrop-filter: blur(20px);
            border-bottom: 1px solid rgba(236, 240, 241, 0.1);
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .logo-header {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .logo-header .yin-yang {
            width: 40px;
            height: 40px;
            background-image: url('/static/yin_yang_familia.png');
            background-size: contain;
            background-repeat: no-repeat;
            background-position: center;
            filter: brightness(0.9);
        }

        .logo-header h1 {
            color: #ecf0f1;
            font-size: 24px;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-name {
            color: #bdc3c7;
            font-weight: 500;
        }

        .user-badge {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            color: white;
            padding: 5px 12px;
            border-radius: 15px;
            font-size: 12px;
            font-weight: 600;
            box-shadow: 0 2px 8px rgba(142, 68, 173, 0.3);
        }

        .logout-btn {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 8px 16px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .logout-btn:hover {
            background: rgba(231, 76, 60, 0.3);
            transform: translateY(-1px);
        }

        .nav-tabs {
            background: rgba(52, 73, 94, 0.8);
            padding: 0 30px;
            display: flex;
            gap: 5px;
            position: relative;
            z-index: 10;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.2);
        }

        .nav-tab {
            padding: 15px 25px;
            background: transparent;
            border: none;
            color: rgba(189, 195, 199, 0.8);
            cursor: pointer;
            border-radius: 10px 10px 0 0;
            transition: all 0.3s ease;
            font-size: 14px;
            font-weight: 500;
            position: relative;
        }

        .nav-tab.active {
            background: rgba(44, 62, 80, 0.9);
            color: #ecf0f1;
            border-bottom: 3px solid #8e44ad;
            box-shadow: 0 -2px 10px rgba(0, 0, 0, 0.2);
        }

        .nav-tab:hover {
            background: rgba(44, 62, 80, 0.6);
            color: #ecf0f1;
            transform: translateY(-2px);
        }

        .main-content {
            padding: 30px;
            position: relative;
            z-index: 5;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: rgba(44, 62, 80, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(189, 195, 199, 0.1);
            border-radius: 15px;
            padding: 25px;
            text-align: center;
            transition: all 0.3s ease;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .stat-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 15px 40px rgba(0, 0, 0, 0.3);
            border-color: rgba(142, 68, 173, 0.3);
        }

        /* Cores para os diferentes status das encomendas */
        .status-pendente {
            color: #f39c12;
            font-weight: 600;
        }
        .status-pronto {
            color: #3498db;
            font-weight: 600;
        }
        .status-entregue {
            color: #2ecc71;
            font-weight: 600;
        }
        .status-cancelado {
            color: #e74c3c;
            font-weight: 600;
        }

        .stat-icon {
            font-size: 36px;
            margin-bottom: 15px;
            filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.3));
        }

        .stat-number {
            font-size: 42px;
            font-weight: 700;
            color: #ecf0f1;
            margin-bottom: 8px;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        .stat-label {
            color: #bdc3c7;
            font-size: 14px;
            font-weight: 500;
        }

        .content-card {
            background: rgba(44, 62, 80, 0.8);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(189, 195, 199, 0.1);
            border-radius: 15px;
            padding: 25px;
            margin-bottom: 20px;
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.2);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }

        .card-title {
            color: #ecf0f1;
            font-size: 20px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .btn-primary {
            background: linear-gradient(135deg, #8e44ad 0%, #9b59b6 100%);
            border: none;
            color: white;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px rgba(142, 68, 173, 0.3);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(142, 68, 173, 0.4);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #34495e 0%, #2c3e50 100%);
            border: none;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s ease;
            margin-left: 10px;
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(52, 73, 94, 0.3);
            border-radius: 10px;
            overflow: hidden;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid rgba(189, 195, 199, 0.1);
        }

        .table th {
            color: #ecf0f1;
            font-weight: 600;
            background: rgba(44, 62, 80, 0.8);
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .table td {
            color: #bdc3c7;
        }

        .table tr:hover {
            background: rgba(52, 73, 94, 0.5);
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 1000;
            backdrop-filter: blur(8px);
        }

        .modal-content {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: rgba(44, 62, 80, 0.98);
            backdrop-filter: blur(20px);
            border: 1px solid rgba(189, 195, 199, 0.2);
            border-radius: 15px;
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 85vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.5);
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            border-bottom: 1px solid rgba(189, 195, 199, 0.1);
            padding-bottom: 15px;
        }

        .modal-title {
            color: #ecf0f1;
            font-size: 22px;
            font-weight: 600;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .close-btn {
            background: none;
            border: none;
            color: #bdc3c7;
            font-size: 28px;
            cursor: pointer;
            padding: 0;
            width: 35px;
            height: 35px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            background: rgba(231, 76, 60, 0.2);
            color: #e74c3c;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            color: #ecf0f1;
            font-weight: 500;
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid rgba(189, 195, 199, 0.2);
            border-radius: 8px;
            background: rgba(52, 73, 94, 0.8);
            color: #ecf0f1;
            font-size: 14px;
            transition: all 0.3s ease;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #8e44ad;
            box-shadow: 0 0 0 3px rgba(142, 68, 173, 0.2);
        }

        .form-group input::placeholder,
        .form-group textarea::placeholder {
            color: rgba(189, 195, 199, 0.6);
        }

        .form-group select option {
            background: #2c3e50;
            color: #ecf0f1;
        }

        .loading {
            text-align: center;
            color: #bdc3c7;
            padding: 40px;
            font-size: 16px;
        }

        .error-message {
            background: rgba(231, 76, 60, 0.2);
            border: 1px solid rgba(231, 76, 60, 0.3);
            color: #e74c3c;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .success-message {
            background: rgba(46, 204, 113, 0.2);
            border: 1px solid rgba(46, 204, 113, 0.3);
            color: #2ecc71;
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
        }

        .fabricacao-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .fabricacao-card {
            background: rgba(52, 73, 94, 0.6);
            border: 1px solid rgba(189, 195, 199, 0.1);
            border-radius: 12px;
            padding: 25px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .fabricacao-title {
            color: #ecf0f1;
            font-weight: 600;
            margin-bottom: 20px;
            font-size: 18px;
            text-shadow: 0 1px 3px rgba(0, 0, 0, 0.3);
        }

        .receita {
            color: #95a5a6;
            font-size: 13px;
            margin-bottom: 8px;
            padding: 5px 0;
            border-left: 3px solid #8e44ad;
            padding-left: 10px;
        }

        .filters-section {
            background: rgba(52, 73, 94, 0.6);
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 25px;
            border: 1px solid rgba(189, 195, 199, 0.1);
        }

        .filters-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .chart-container {
            background: rgba(52, 73, 94, 0.6);
            border-radius: 12px;
            padding: 25px;
            margin-bottom: 25px;
            border: 1px solid rgba(189, 195, 199, 0.1);
            min-height: 300px;
        }

        .report-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .summary-item {
            background: rgba(44, 62, 80, 0.8);
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            border: 1px solid rgba(189, 195, 199, 0.1);
        }

        .summary-value {
            font-size: 28px;
            font-weight: 700;
            color: #ecf0f1;
            margin-bottom: 5px;
        }

        .summary-label {
            color: #95a5a6;
            font-size: 14px;
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-direction: column;
                gap: 15px;
            }

            .nav-tabs {
                padding: 0 20px;
                overflow-x: auto;
                white-space: nowrap;
                padding-bottom: 10px;
            }
            
            .nav-tabs button {
                min-width: 100px;
                font-size: 12px;
                padding: 8px 12px;
            }

            .main-content {
                padding: 20px;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .modal-content {
                width: 95%;
                padding: 20px;
                max-height: 90vh;
                overflow-y: auto;
            }

            .filters-grid {
                grid-template-columns: 1fr;
            }
            
            .content-card {
                padding: 15px;
                margin: 10px 0;
            }
            
            .card-header {
                flex-direction: column;
                gap: 15px;
                align-items: stretch;
            }
            
            .table {
                font-size: 12px;
                overflow-x: auto;
                display: block;
                white-space: nowrap;
            }
            
            .table thead,
            .table tbody,
            .table tr {
                display: block;
            }
            
            .table thead tr {
                position: absolute;
                top: -9999px;
                left: -9999px;
            }
            
            .table tbody tr {
                border: 1px solid rgba(189, 195, 199, 0.2);
                margin-bottom: 10px;
                padding: 15px;
                border-radius: 8px;
                background: rgba(52, 73, 94, 0.3);
                display: block;
                white-space: normal;
            }
            
            .table td {
                border: none;
                display: block;
                text-align: left;
                padding: 8px 0;
                white-space: normal;
                position: relative;
            }
            
            .table td:before {
                content: attr(data-label) ": ";
                font-weight: bold;
                color: #8e44ad;
                display: inline-block;
                width: 120px;
                margin-right: 10px;
            }
            
            .form-row {
                flex-direction: column;
            }
            
            .form-row .form-group {
                width: 100%;
            }
            
            .fabricacao-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="logo-header">
            <div class="yin-yang"></div>
            <h1>FAC√á√ÉO CONTROL</h1>
        </div>
        <div class="user-info">
            <span class="user-name" id="userName">Tofu - Administrador</span>
            <!-- r√≥tulo que indica o papel do usu√°rio, atualizado dinamicamente em loadUserInfo() -->
            <span id="userBadge" class="user-badge">USU√ÅRIO</span>
            <button class="logout-btn" onclick="logout()">Sair</button>
        </div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="showTab('dashboard')">Dashboard</button>
        <button class="nav-tab" onclick="showTab('membros')">Membros</button>
        <button class="nav-tab" onclick="showTab('rotas')">Rotas</button>
        <button class="nav-tab" onclick="showTab('encomendas')">Encomendas</button>
        <button class="nav-tab" onclick="showTab('estoque')">Estoque</button>
        <button class="nav-tab" onclick="showTab('inventarioFamilia')">Invent√°rio Fam√≠lia</button>
        <button class="nav-tab" onclick="showTab('relatorios')">Relat√≥rios</button>
    </div>

    <div class="main-content">
        <!-- Dashboard Tab -->
        <div id="dashboard" class="tab-content active">
            <div class="stats-grid">
                <div class="stat-card">
                    <div class="stat-icon">üë•</div>
                    <div class="stat-number" id="totalMembros">1</div>
                    <div class="stat-label">Total Membros</div>
                    <div style="color: #2ecc71; font-size: 12px; margin-top: 8px;">+1 este m√™s</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üöö</div>
                    <div class="stat-number" id="rotasPendentesDash">0</div>
                    <div class="stat-label">Rotas Pendentes</div>
                    <div id="rotasEntreguesDash" style="color: #2ecc71; font-size: 12px; margin-top: 8px;">+0 entregues</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üì¶</div>
                    <!-- Renomeado para encomendasResumo para evitar conflito com a aba Encomendas -->
                    <div class="stat-number" id="encomendasResumo">0</div>
                    <div class="stat-label">Encomendas</div>
                    <div id="encomendasEntreguesDash" style="color: #f39c12; font-size: 12px; margin-top: 8px;">+0 pendentes</div>
                </div>
                <div class="stat-card">
                    <div class="stat-icon">üí∞</div>
                    <div class="stat-number" id="totalVendasDash">R$ 0,00</div>
                    <div class="stat-label">Vendas do M√™s</div>
                    <div id="totalComissoesDash" style="color: #2ecc71; font-size: 12px; margin-top: 8px;">+R$ 0,00 comiss√µes</div>
                </div>

                <!-- Valor em estoque de materiais -->
                <div class="stat-card">
                    <div class="stat-icon">üî©</div>
                    <div class="stat-number" id="valorMateriaisDash">R$ 0,00</div>
                    <div class="stat-label">Valor em Materiais</div>
                    <div style="color: #bdc3c7; font-size: 12px; margin-top: 8px;">&nbsp;</div>
                </div>
                <!-- Valor em estoque de muni√ß√µes -->
                <div class="stat-card">
                    <div class="stat-icon">üí£</div>
                    <div class="stat-number" id="valorMunicoesDash">R$ 0,00</div>
                    <div class="stat-label">Valor em Muni√ß√µes</div>
                    <div style="color: #bdc3c7; font-size: 12px; margin-top: 8px;">&nbsp;</div>
                </div>
                <!-- Meta mensal de rotas -->
                <div class="stat-card">
                    <div class="stat-icon">üéØ</div>
                    <div class="stat-number" id="metaRotasDash">0</div>
                    <div class="stat-label">Meta de Rotas do M√™s</div>
                    <div id="metaRotasDiffDash" style="color: #f39c12; font-size: 12px; margin-top: 8px;">0 para bater a meta</div>
                </div>
            </div>

            <!-- Barra de filtros para o dashboard (per√≠odo e membro) -->
            <div style="display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; align-items: flex-end;">
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: block; color: #bdc3c7; font-size: 14px; margin-bottom: 5px;">In√≠cio</label>
                    <input type="date" id="dashboardStart" style="padding: 8px; border-radius: 5px; border: 1px solid #34495e; background: #2c3e50; color: #ecf0f1;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: block; color: #bdc3c7; font-size: 14px; margin-bottom: 5px;">Fim</label>
                    <input type="date" id="dashboardEnd" style="padding: 8px; border-radius: 5px; border: 1px solid #34495e; background: #2c3e50; color: #ecf0f1;">
                </div>
                <div class="form-group" style="margin-bottom: 0;">
                    <label style="display: block; color: #bdc3c7; font-size: 14px; margin-bottom: 5px;">Membro</label>
                    <select id="dashboardMembroSelect" style="padding: 8px; border-radius: 5px; border: 1px solid #34495e; background: #2c3e50; color: #ecf0f1;">
                        <option value="">Todos</option>
                    </select>
                </div>
                <button class="btn-secondary" style="height: 38px; padding: 0 20px;" onclick="applyDashboardFilters()">Filtrar</button>
            </div>

            <div class="content-card">
                <h3 class="card-title">Vis√£o Geral do Sistema</h3>
                <p style="color: #95a5a6; line-height: 1.6;">
                    Bem-vindo ao sistema de controle da fac√ß√£o! Use as abas acima para navegar pelas funcionalidades. 
                    O sistema oferece controle completo de membros, rotas, encomendas, estoque e relat√≥rios detalhados.
                </p>
            </div>
        </div>

        <!-- Invent√°rio Fam√≠lia Tab -->
        <div id="inventarioFamilia" class="tab-content" style="display: none;">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Invent√°rio da Fam√≠lia</h3>
                    <div id="inventarioFamiliaActions" style="display:flex; gap:10px;">
                        <!-- Bot√µes de a√ß√£o ser√£o exibidos conforme permiss√µes do usu√°rio -->
                    </div>
                </div>
                <div id="inventarioFamiliaLoading" class="loading-message">Carregando...</div>
                    <div id="inventarioFamiliaContent" style="display:none;">
                    <h4 style="color:#ecf0f1; margin-top: 0;">Itens do Invent√°rio</h4>
                    <div id="inventarioFamiliaGrid" style="margin-bottom: 20px;">
                        <!-- Grid de categorias e itens ser√° renderizado aqui -->
                    </div>
                    <hr style="margin: 30px 0; border-color: #34495e;">
                    
                    <!-- Se√ß√£o de Requisi√ß√µes Melhorada -->
                    <div style="background: linear-gradient(135deg, #2c3e50 0%, #34495e 100%); padding: 20px; border-radius: 10px; margin-bottom: 20px;">
                        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                            <h4 style="color:#ecf0f1; margin: 0; font-size: 1.4em; font-weight: 600;">
                                <i style="margin-right: 10px;">üìã</i>Requisi√ß√µes de Materiais
                            </h4>
                            <button class="btn-primary" onclick="openNovaRequisicaoFamilia()" style="padding: 10px 20px; font-weight: 600;">
                                <i style="margin-right: 8px;">‚ûï</i>Nova Requisi√ß√£o
                            </button>
                        </div>
                        
                        <div style="background: rgba(255,255,255,0.05); border-radius: 8px; overflow: hidden; border: 1px solid rgba(255,255,255,0.1);">
                            <table style="width: 100%; border-collapse: collapse; margin: 0;">
                                <thead>
                                    <tr style="background: rgba(0,0,0,0.3);">
                                        <th style="padding: 15px 12px; text-align: left; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db;">
                                            üë§ Solicitante
                                        </th>
                                        <th style="padding: 15px 12px; text-align: left; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db;">
                                            üì¶ Item
                                        </th>
                                        <th style="padding: 15px 12px; text-align: center; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db; width: 100px;">
                                            üî¢ Qtd
                                        </th>
                                        <th style="padding: 15px 12px; text-align: center; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db; width: 120px;">
                                            üìä Status
                                        </th>
                                        <th style="padding: 15px 12px; text-align: center; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db; width: 130px;">
                                            üìÖ Data
                                        </th>
                                        <th style="padding: 15px 12px; text-align: center; color: #ecf0f1; font-weight: 600; border-bottom: 2px solid #3498db; width: 150px;">
                                            ‚öôÔ∏è A√ß√µes
                                        </th>
                                    </tr>
                                </thead>
                                <tbody id="requisicoesFamiliaTableBody" style="background: rgba(255,255,255,0.02);">
                                    <!-- Requisi√ß√µes ser√£o renderizadas aqui -->
                                </tbody>
                            </table>
                            
                            <!-- Mensagem quando n√£o h√° requisi√ß√µes -->
                            <div id="noRequisicoes" style="display: none; text-align: center; padding: 40px; color: #bdc3c7;">
                                <div style="font-size: 3em; margin-bottom: 15px; opacity: 0.5;">üìã</div>
                                <h5 style="color: #ecf0f1; margin-bottom: 10px;">Nenhuma requisi√ß√£o encontrada</h5>
                                <p style="margin: 0; opacity: 0.7;">Clique em "Nova Requisi√ß√£o" para solicitar materiais do estoque.</p>
                            </div>
                        </div>
                    </div>
                </div>             </table>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar item ao Invent√°rio da Fam√≠lia -->
        <div id="addItemFamiliaModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal('addItemFamiliaModal')">&times;</span>
                <h3 style="margin-top:0">Adicionar Item ao Invent√°rio</h3>
                <div class="modal-body">
                    <div style="margin-bottom:10px;">
                        <label>Categoria:<br>
                            <input type="text" id="addItemCategoria" placeholder="Ex.: Produtos Comprados" style="width:100%; padding:4px;" required>
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Item:<br>
                            <input type="text" id="addItemNome" placeholder="Nome do item" style="width:100%; padding:4px;" required>
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Quantidade:<br>
                            <input type="number" id="addItemQuantidade" min="0" value="0" style="width:100%; padding:4px;" required>
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Pre√ßo Unit√°rio (opcional):<br>
                            <input type="number" id="addItemPreco" min="0" step="0.01" style="width:100%; padding:4px;">
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Motivo da altera√ß√£o:<br>
                            <textarea id="addItemMotivo" placeholder="Descreva o motivo da altera√ß√£o no estoque" style="width:100%; padding:4px; height:60px; resize:vertical;" required></textarea>
                        </label>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn-primary" onclick="submitAddItemFamilia()">Salvar</button>
                        <button class="btn-secondary" onclick="closeModal('addItemFamiliaModal')">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para nova requisi√ß√£o de item da Fam√≠lia -->
        <div id="novaReqFamiliaModal" class="modal">
            <div class="modal-content" style="max-width: 600px;">
                <span class="close-btn" onclick="closeModal('novaReqFamiliaModal')">&times;</span>
                <h3 style="margin-top:0">Nova Requisi√ß√£o de Material</h3>
                <div class="modal-body">
                    <div style="margin-bottom:15px;">
                        <label>Solicitante:<br>
                            <select id="reqSolicitanteSelect" style="width:100%; padding:4px;" required>
                                <option value="">Selecione o solicitante...</option>
                            </select>
                        </label>
                    </div>
                    
                    <div style="margin-bottom:15px;">
                        <h4 style="color:#ecf0f1; margin-bottom:10px;">Itens Solicitados</h4>
                        <div id="reqItensContainer">
                            <div class="req-item-row" style="display:grid; grid-template-columns: 2fr 1fr auto; gap:10px; margin-bottom:10px; align-items:end;">
                                <div>
                                    <label>Item:<br>
                                        <select class="req-item-select" style="width:100%; padding:4px;"></select>
                                    </label>
                                </div>
                                <div>
                                    <label>Quantidade:<br>
                                        <input type="number" class="req-item-quantidade" min="1" value="1" style="width:100%; padding:4px;" required>
                                    </label>
                                </div>
                                <div>
                                    <button type="button" class="btn-secondary" onclick="removeReqItem(this)" style="padding:4px 8px;">Remover</button>
                                </div>
                            </div>
                        </div>
                        <button type="button" class="btn-secondary" onclick="addReqItem()" style="margin-top:10px;">+ Adicionar Item</button>
                    </div>
                    
                    <div style="text-align:right;">
                        <button class="btn-primary" onclick="submitNovaRequisicaoFamilia()">Enviar Requisi√ß√£o</button>
                        <button class="btn-secondary" onclick="closeModal('novaReqFamiliaModal')">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal para adicionar estoque a um item existente -->
        <div id="adicionarEstoqueModal" class="modal">
            <div class="modal-content">
                <span class="close-btn" onclick="closeModal('adicionarEstoqueModal')">&times;</span>
                <h3 style="margin-top:0">Adicionar Estoque</h3>
                <div class="modal-body">
                    <div style="margin-bottom:10px;">
                        <label>Item:<br>
                            <input type="text" id="estoqueItemNome" readonly style="width:100%; padding:4px; background-color: #34495e; color: #bdc3c7;">
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Quantidade Atual:<br>
                            <input type="text" id="estoqueQuantidadeAtual" readonly style="width:100%; padding:4px; background-color: #34495e; color: #bdc3c7;">
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Quantidade a Adicionar:<br>
                            <input type="number" id="estoqueQuantidadeAdicionar" min="1" value="1" style="width:100%; padding:4px;" required>
                        </label>
                    </div>
                    <div style="margin-bottom:10px;">
                        <label>Motivo da altera√ß√£o:<br>
                            <textarea id="estoqueMotivo" placeholder="Descreva o motivo da altera√ß√£o no estoque" style="width:100%; padding:4px; height:60px; resize:vertical;" required></textarea>
                        </label>
                    </div>
                    <div style="text-align:right;">
                        <button class="btn-primary" onclick="submitAdicionarEstoque()">Adicionar</button>
                        <button class="btn-secondary" onclick="closeModal('adicionarEstoqueModal')">Cancelar</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Membros Tab -->
        <div id="membros" class="tab-content">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Sistema de Membros</h3>
                    <button class="btn-primary" onclick="openModal('membroModal')">Novo Membro</button>
                </div>
                <div id="membrosLoading" class="loading">Carregando membros...</div>
                <div id="membrosTable" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Nome</th>
                                <th>RG</th>
                                <th>Telefone</th>
                                <th>Cargo</th>
                                <th>Data Cadastro</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="membrosTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
            <!-- Solicita√ß√µes Pendentes (Cadastro de Usu√°rios) -->
            <div class="content-card" id="pendentesCard" style="display:none; margin-top:20px;">
                <div class="card-header">
                    <h3 class="card-title">Solicita√ß√µes de Cadastro</h3>
                </div>
                <div id="pendentesLoading" class="loading">Carregando solicita√ß√µes...</div>
                <div id="pendentesTable" style="display:none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Usu√°rio</th>
                                <th>Nome</th>
                                <th>RG</th>
                                <th>Telefone</th>
                                <th>Cargo</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="pendentesTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Rotas Tab -->
        <div id="rotas" class="tab-content">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Sistema de Rotas</h3>
                    <button class="btn-primary" onclick="openModal('rotaModal')">Nova Rota</button>
                </div>
                <div id="rotasLoading" class="loading">Carregando rotas...</div>
                <div id="rotasTable" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Membro</th>
                                <th>Quantidade</th>
                                <th>Data Entrega</th>
                                <th>Status</th>
                                <th>Pagamento</th>
                                <th>Pagante</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="rotasTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Encomendas Tab -->
        <div id="encomendas" class="tab-content">
            <div class="content-card">
                <div class="card-header" style="display: flex; flex-wrap: wrap; align-items: center; justify-content: space-between; gap: 10px;">
                    <div style="display:flex; align-items:center; gap:10px;">
                        <h3 class="card-title" style="margin:0;">üì¶ Sistema de Encomendas</h3>
                        <!-- Filtro de status: mostra apenas pendentes/prontas ou todas -->
                        <select id="encomendaStatusFiltro" onchange="applyEncomendaFilter()" style="padding:6px 10px; border-radius:6px; background: rgba(255,255,255,0.1); color:#ecf0f1; border:1px solid rgba(255,255,255,0.2); font-size:14px;">
                            <option value="ativos">Pendentes/Prontas</option>
                            <option value="todas">Todas</option>
                        </select>
                    </div>
                    <button class="btn-primary" onclick="openModal('encomendaModal')">+ Nova Encomenda</button>
                    <!-- Configura√ß√£o de comiss√£o: vis√≠vel apenas para l√≠deres/administradores -->
                    <div id="commissionRateContainer" style="display:none; align-items:center; gap:8px; margin-left:auto;">
                        <label for="commissionRateInput" style="margin-right:6px; font-size:14px;">Comiss√£o (%)</label>
                        <input type="number" id="commissionRateInput" min="0" max="100" step="0.1" style="width:80px; padding:4px 6px; border-radius:4px; border:1px solid rgba(255,255,255,0.3); background:rgba(255,255,255,0.1); color:#ecf0f1; text-align:center;">
                        <button class="btn-primary" style="padding:6px 12px; margin-left:4px;" onclick="updateCommissionRate()">Salvar</button>
                    </div>
                </div>
                
                <div class="table-container">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Cliente</th>
                                <th>Fam√≠lia</th>
                                <th>Telefone</th>
                                <th>Vendedor</th>
                                <th>Muni√ß√µes</th>
                        <th>Valor Total</th>
                        <th>Comiss√£o</th>
                        <th>Valor L√≠quido</th>
                                <th>Status</th>
                                <th>Data/Hora</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="encomendasTableBody">
                            <tr>
                            <td colspan="11" style="text-align: center; color: #bdc3c7; padding: 40px; font-size: 16px;">
                                    üì¶ Nenhuma encomenda cadastrada<br>
                                    <small>Clique em "Nova Encomenda" para come√ßar</small>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <div class="summary-cards" style="margin-top: 30px; display: grid; grid-template-columns: repeat(auto-fit, minmax(180px, 1fr)); gap: 20px;">
                    <div class="stat-card">
                        <div class="stat-icon">üì¶</div>
                        <div class="stat-number" id="totalEncomendas">0</div>
                        <div class="stat-label">Total de Encomendas</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚è≥</div>
                        <div class="stat-number" id="encomendasPendentes">0</div>
                        <div class="stat-label">Pendentes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚úÖ</div>
                        <div class="stat-number" id="encomendasEntregues">0</div>
                        <div class="stat-label">Entregues</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">üí∞</div>
                        <div class="stat-number" id="totalComissoes">R$ 0,00</div>
                        <div class="stat-label">Total em Comiss√µes</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">‚öôÔ∏è</div>
                        <div class="stat-number" id="necessidadeFabricacao">0</div>
                        <div class="stat-label">Necessidade de Fabrica√ß√£o</div>
                    </div>
                    <!-- Novo card de lucro total ap√≥s deduzir comiss√£o, taxa de fabrica√ß√£o e custo dos materiais -->
                    <div class="stat-card">
                        <div class="stat-icon">üíπ</div>
                        <div class="stat-number" id="lucroTotal">R$ 0,00</div>
                        <div class="stat-label">Lucro Total (Venda¬†‚Äì¬†Materiais¬†‚Äì¬†Comiss√£o¬†‚Äì¬†Taxa¬†Fabr.)</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Estoque Tab -->
        <div id="estoque" class="tab-content">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Controle de Estoque</h3>
                    <!--
                        Bot√£o de adicionar item no estoque. O atributo id permite que o
                        JavaScript oculte este bot√£o para usu√°rios sem permiss√£o (ex.: membros).
                    -->
                    <button id="btnAddEstoque" class="btn-primary" onclick="openModal('estoqueModal')">Adicionar Item</button>
                    <!-- Bot√£o para retirada de estoque (corre√ß√µes). Exibido apenas para admin/gerente/l√≠der -->
                    <button id="btnRetiradaEstoque" class="btn-secondary" style="margin-left: 10px;" onclick="openModal('retiradaModal')">Retirar Item</button>
                    <!-- Bot√£o para sa√≠da avulsa. Exibido apenas para l√≠deres -->
                    <button id="btnSaidaAvulsa" class="btn-secondary" style="margin-left: 10px;" onclick="openModal('saidaAvulsaModal')">Sa√≠da Avulsa</button>
                    <!-- Bot√£o para gerar invent√°rio do estoque (auditagem). Exibido apenas para admin/gerente/l√≠der -->
                    <button id="btnInventario" class="btn-secondary" style="margin-left: 10px;" onclick="openModal('inventarioModal')">Invent√°rio</button>
                </div>
                
                <!--
                    A antiga se√ß√£o de fabrica√ß√£o de muni√ß√µes foi removida porque o sistema passar√°
                    a tratar a produ√ß√£o de muni√ß√µes atrav√©s do lan√ßamento de itens no estoque.
                    Caso seja necess√°rio no futuro, consulte o hist√≥rico de commits para recuperar
                    o bloco removido.
                -->

                <div id="estoqueLoading" class="loading">Carregando estoque...</div>
                <div id="estoqueContent" style="display: none;">
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 25px; margin-top: 25px;">
                        <div>
                            <h4 style="color: #ecf0f1; margin-bottom: 20px; font-size: 18px;">Mat√©ria-Prima</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Material</th>
                                        <th>Quantidade</th>
                                        <th>Pre√ßo Unit.</th>
                                    </tr>
                                </thead>
                                <tbody id="materiaisTableBody">
                                </tbody>
                            </table>
                        </div>
                        <div>
                            <h4 style="color: #ecf0f1; margin-bottom: 20px; font-size: 18px;">Muni√ß√µes</h4>
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Tipo</th>
                                        <th>Quantidade</th>
                                        <th>Pre√ßo Unit.</th>
                                    </tr>
                                </thead>
                                <tbody id="municoesTableBody">
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Relat√≥rios Tab -->
        <div id="relatorios" class="tab-content">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Sistema de Relat√≥rios</h3>
                    <div>
                        <button class="btn-primary" onclick="gerarRelatorio()">Gerar Relat√≥rio</button>
                        <button class="btn-secondary" onclick="exportarRelatorio()">Exportar PDF</button>
                    </div>
                </div>

                <div class="filters-section">
                    <h4 style="color: #ecf0f1; margin-bottom: 20px;">Filtros de Relat√≥rio</h4>
                    <div class="filters-grid">
                        <div class="form-group">
                            <label>Tipo de Relat√≥rio</label>
                            <select id="tipoRelatorio" onchange="updateRelatorioOptions()">
                                <option value="geral">Relat√≥rio Geral</option>
                                <option value="membros">Relat√≥rio de Membros</option>
                                <option value="rotas">Relat√≥rio de Rotas</option>
                                <option value="encomendas">Relat√≥rio de Encomendas</option>
                                <option value="estoque">Relat√≥rio de Estoque</option>
                                <option value="financeiro">Relat√≥rio Financeiro</option>
                                <option value="usuarios">Relat√≥rio por Usu√°rio</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>Per√≠odo</label>
                            <select id="periodoRelatorio">
                                <option value="hoje">Hoje</option>
                                <option value="semana">Esta Semana</option>
                                <option value="mes">Este M√™s</option>
                                <option value="trimestre">Este Trimestre</option>
                                <option value="ano">Este Ano</option>
                                <option value="personalizado">Per√≠odo Personalizado</option>
                            </select>
                        </div>
                        <div class="form-group" id="dataInicioGroup" style="display: none;">
                            <label>Data In√≠cio</label>
                            <input type="date" id="dataInicio">
                        </div>
                        <div class="form-group" id="dataFimGroup" style="display: none;">
                            <label>Data Fim</label>
                            <input type="date" id="dataFim">
                        </div>
                        <div class="form-group" id="membroFiltroGroup" style="display: none;">
                            <label>Membro Espec√≠fico</label>
                            <select id="membroFiltro">
                                <option value="">Todos os Membros</option>
                            </select>
                        </div>
                        <div class="form-group" id="usuarioFiltroGroup" style="display: none;">
                            <label>Usu√°rio</label>
                            <select id="usuarioFiltro">
                                <option value="">Todos os Usu√°rios</option>
                            </select>
                        </div>
                    </div>
                </div>

                <div id="relatorioContent">
                    <div class="report-summary">
                        <div class="summary-item">
                            <div class="summary-value" id="totalMembrosRelatorio">0</div>
                            <div class="summary-label">Total de Membros</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalRotasRelatorio">0</div>
                            <div class="summary-label">Total de Rotas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalEncomendasRelatorio">0</div>
                            <div class="summary-label">Total de Encomendas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalVendasRelatorio">R$ 0,00</div>
                            <div class="summary-label">Total de Vendas</div>
                        </div>
                        <div class="summary-item">
                            <div class="summary-value" id="totalComissoesRelatorio">R$ 0,00</div>
                            <div class="summary-label">Total de Comiss√µes</div>
                        </div>
                    </div>

                    <div class="chart-container">
                        <h4 style="color: #ecf0f1; margin-bottom: 20px;">Gr√°fico de Atividades</h4>
                        <div id="chartArea" style="display: flex; align-items: center; justify-content: center; height: 200px; color: #95a5a6;">
                            Selecione um per√≠odo e clique em "Gerar Relat√≥rio" para visualizar os dados
                        </div>
                    </div>

                    <div class="content-card">
                        <h4 class="card-title">Detalhes do Relat√≥rio</h4>
                        <div id="relatorioDetalhes">
                            <table class="table">
                                <thead>
                                    <tr id="relatorioTableHeader">
                                        <th>Data</th>
                                        <th>Tipo</th>
                                        <th>Descri√ß√£o</th>
                                        <th>Valor</th>
                                        <th>Status</th>
                                    </tr>
                                </thead>
                                <tbody id="relatorioTableBody">
                                    <tr>
                                        <td colspan="5" style="text-align: center; color: #95a5a6; padding: 40px;">
                                            Nenhum dado encontrado para o per√≠odo selecionado
                                        </td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Imagens Tab -->
        <div id="imagens" class="tab-content">
            <div class="content-card">
                <div class="card-header">
                    <h3 class="card-title">Gerenciamento de Imagens</h3>
                    <button class="btn-primary" onclick="openModal('imagemModal')">Upload Imagem</button>
                </div>
                <div id="imagensLoading" class="loading">Carregando imagens...</div>
                <div id="imagensTable" style="display: none;">
                    <table class="table">
                        <thead>
                            <tr>
                                <th>Arquivo</th>
                                <th>Categoria</th>
                                <th>Relacionado</th>
                                <th>Data Upload</th>
                                <th>A√ß√µes</th>
                            </tr>
                        </thead>
                        <tbody id="imagensTableBody">
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Modal Membro -->
    <div id="membroModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Novo Membro</h3>
                <button class="close-btn" onclick="closeModal('membroModal')">&times;</button>
            </div>
            <form id="membroForm">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="membroNome" required>
                </div>
                <div class="form-group">
                    <label>RG</label>
                    <input type="text" id="membroRG" required>
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" id="membroTelefone" placeholder="(DD) XXXXX‚ÄëXXXX">
                </div>
                <div class="form-group">
                    <label>Cargo</label>
                    <select id="membroCargo">
                        <option value="membro">Membro</option>
                        <option value="gerente">Gerente</option>
                        <option value="lider">L√≠der</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Cadastrar Membro</button>
            </form>
        </div>
    </div>

    <!-- Modal Rota -->
    <div id="rotaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Rota</h3>
                <button class="close-btn" onclick="closeModal('rotaModal')">&times;</button>
            </div>
            <form id="rotaForm">
                <div class="form-group">
                    <label>Membro</label>
                    <select id="rotaMembro" required>
                        <option value="">Selecione um membro...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="rotaQuantidade" min="1" required>
                </div>
                <div class="form-group">
                    <label>Data</label>
                    <input type="date" id="rotaData" required>
                </div>
                <!-- Status oculto: por padr√£o todas as rotas criadas manualmente s√£o marcadas como entregues -->
                <input type="hidden" id="rotaStatus" value="entregue">
                <div class="form-group">
                    <label>Comprovante (Imagem)</label>
                    <input type="file" id="rotaComprovante" accept="image/*">
                </div>
                <button type="submit" class="btn-primary">Cadastrar Rota</button>
            </form>
        </div>
    </div>

    <!-- Modal Encomenda -->
    <div id="encomendaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Encomenda</h3>
                <button class="close-btn" onclick="closeModal('encomendaModal')">&times;</button>
            </div>
            <form id="encomendaForm">
                <div class="form-group">
                    <label>Cliente</label>
                    <input type="text" id="encomendaCliente" required>
                </div>
                <!-- Campo de telefone do cliente -->
                <div class="form-group">
                    <label>Telefone do Cliente</label>
                    <input type="tel" id="encomendaClienteTelefone" placeholder="(DD) XXXXX‚ÄëXXXX">
                </div>
                <div class="form-group">
                    <label>Fam√≠lia</label>
                    <!-- Sele√ß√£o de fam√≠lia cadastrada. Ser√° preenchida dinamicamente -->
                    <select id="encomendaFamiliaSelect" required onchange="handleFamiliaSelectChange()">
                        <option value="">Selecione uma fam√≠lia...</option>
                        <option value="outro">Outro...</option>
                    </select>
                    <!-- Campo de texto para nova fam√≠lia, exibido quando selecionado "Outro" -->
                    <input type="text" id="encomendaFamiliaOutro" placeholder="Nome da fam√≠lia" style="display:none; margin-top: 10px;" />
                    <!-- Bot√£o para cadastrar fam√≠lia (vis√≠vel apenas para gerentes/admin) -->
                    <button type="button" id="btnAddFamilia" class="btn-secondary" style="margin-top:10px; display:none;" onclick="openModal('familiaModal')">Cadastrar Fam√≠lia</button>
                </div>

                <!-- Sele√ß√£o do usu√°rio respons√°vel pela encomenda -->
                <div class="form-group">
                    <label>Usu√°rio</label>
                    <select id="encomendaUsuarioSelect" required>
                        <!-- Ser√° preenchido dinamicamente -->
                    </select>
                </div>
                
                <h4 style="color: #ecf0f1; margin: 25px 0 20px;">Muni√ß√µes</h4>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                    <div class="form-group">
                        <label>5mm (Qtd)</label>
                        <input type="number" id="municao5mm" min="0" value="1000" onchange="calcularTotal()">
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo 5mm</label>
                        <input type="number" id="preco5mm" value="100" step="0.01" onchange="calcularTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label>9mm (Qtd)</label>
                        <input type="number" id="municao9mm" min="0" value="0" onchange="calcularTotal()">
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo 9mm</label>
                        <input type="number" id="preco9mm" value="125" step="0.01" onchange="calcularTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label>762 (Qtd)</label>
                        <input type="number" id="municao762mm" min="0" value="0" onchange="calcularTotal()">
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo 762</label>
                        <input type="number" id="preco762mm" value="200" step="0.01" onchange="calcularTotal()">
                    </div>
                    
                    <div class="form-group">
                        <label>12cbc (Qtd)</label>
                        <input type="number" id="municao12cbc" min="0" value="0" onchange="calcularTotal()">
                    </div>
                    <div class="form-group">
                        <label>Pre√ßo 12cbc</label>
                        <input type="number" id="preco12cbc" value="200" step="0.01" onchange="calcularTotal()">
                    </div>
                </div>
                
                <div style="background: rgba(52, 73, 94, 0.8); padding: 20px; border-radius: 10px; margin: 25px 0; border: 1px solid rgba(142, 68, 173, 0.3);">
                    <div style="color: #ecf0f1; font-weight: 600; font-size: 16px;">Valor Total: <span id="valorTotal">R$ 100.000,00</span></div>
                    <div style="color: #2ecc71; font-weight: 600; font-size: 16px; margin-top: 5px;">Comiss√£o (7%): <span id="comissaoTotal">R$ 7.000,00</span></div>
                </div>
                
                <div class="form-group">
                    <label>Status</label>
                    <select id="encomendaStatus">
                        <option value="pendente">Pendente</option>
                        <option value="pronto">Pronto</option>
                        <option value="entregue">Entregue</option>
                    </select>
                </div>
                
                <button type="submit" class="btn-primary">Cadastrar Encomenda</button>
            </form>
        </div>
    </div>

    <!-- Modal Estoque -->
    <div id="estoqueModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Adicionar ao Estoque</h3>
                <button class="close-btn" onclick="closeModal('estoqueModal')">&times;</button>
            </div>
            <form id="estoqueForm">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="estoqueType" onchange="updateItemOptions()" required>
                        <option value="">Selecione o tipo...</option>
                        <option value="material">Mat√©ria-Prima</option>
                        <option value="municao">Muni√ß√µes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="estoqueItem" required>
                        <option value="">Selecione um item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="estoqueQuantidade" min="1" required>
                </div>
                <!-- Pergunta se deseja baixar materiais do estoque ao lan√ßar muni√ß√µes. Somente aparece quando o tipo
                     selecionado for "municao". -->
                <div class="form-group" id="estoqueBaixarMateriaisGroup" style="display: none;">
                    <label>Baixar materiais utilizados?</label>
                    <select id="estoqueBaixarMateriais">
                        <option value="sim">Sim, baixar do estoque</option>
                        <option value="nao">N√£o, entrada avulsa</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Adicionar ao Estoque</button>
            </form>
        </div>
    </div>

    <!-- Modal Retirada de Estoque -->
    <div id="retiradaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Retirar Item do Estoque</h3>
                <button class="close-btn" onclick="closeModal('retiradaModal')">&times;</button>
            </div>
            <form id="retiradaForm">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="retiradaTipo" required onchange="updateRetiradaItems()">
                        <option value="">Selecione o tipo...</option>
                        <option value="material">Mat√©ria-Prima</option>
                        <option value="municao">Muni√ß√µes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="retiradaItem" required>
                        <option value="">Selecione um item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="retiradaQuantidade" min="1" required>
                </div>
                <button type="submit" class="btn-primary">Confirmar Retirada</button>
            </form>
        </div>
    </div>

    <!-- Modal Sa√≠da Avulsa -->
    <div id="saidaAvulsaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Sa√≠da Avulsa de Estoque</h3>
                <button class="close-btn" onclick="closeModal('saidaAvulsaModal')">&times;</button>
            </div>
            <form id="saidaAvulsaForm">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="saidaTipo" required onchange="updateSaidaItems()">
                        <option value="">Selecione o tipo...</option>
                        <option value="material">Mat√©ria-Prima</option>
                        <option value="municao">Muni√ß√µes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="saidaItem" required>
                        <option value="">Selecione um item...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="saidaQuantidade" min="1" required>
                </div>
                <div class="form-group">
                    <label>Destinos (Membros)</label>
                    <select id="saidaDestinos" multiple style="height: 120px;">
                        <!-- Preenchido dinamicamente com membros -->
                    </select>
                </div>
                <button type="submit" class="btn-primary">Registrar Sa√≠da</button>
            </form>
        </div>
    </div>

    <!-- Modal Invent√°rio de Estoque -->
    <div id="inventarioModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <div class="modal-header">
                <h3 class="modal-title">Invent√°rio de Estoque</h3>
                <button class="close-btn" onclick="closeModal('inventarioModal')">&times;</button>
            </div>
            <div class="modal-body" style="max-height: 400px; overflow-y: auto;">
                <table class="table">
                    <thead>
                        <tr>
                            <th>Tipo</th>
                            <th>Item</th>
                            <th>Quantidade</th>
                        </tr>
                    </thead>
                    <tbody id="inventarioTableBody">
                    </tbody>
                </table>
            </div>
        </div>
    </div>

    <!-- Modal Fam√≠lia -->
    <div id="familiaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Nova Fam√≠lia</h3>
                <button class="close-btn" onclick="closeModal('familiaModal')">&times;</button>
            </div>
            <form id="familiaForm">
                <div class="form-group">
                    <label>Nome da Fam√≠lia</label>
                    <input type="text" id="familiaNome" required>
                </div>
                <button type="submit" class="btn-primary">Cadastrar Fam√≠lia</button>
            </form>
        </div>
    </div>

    <!-- Modal Imagem -->
    <div id="imagemModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Upload Imagem</h3>
                <button class="close-btn" onclick="closeModal('imagemModal')">&times;</button>
            </div>
            <form id="imagemForm">
                <div class="form-group">
                    <label>Arquivo</label>
                    <input type="file" id="imagemArquivo" accept="image/*" required>
                </div>
                <div class="form-group">
                    <label>Categoria</label>
                    <select id="imagemCategoria" required>
                        <option value="">Selecione...</option>
                        <option value="rota">Comprovante de Rota</option>
                        <option value="pagamento">Comprovante de Pagamento</option>
                        <option value="fabricacao">Fabrica√ß√£o</option>
                        <option value="outros">Outros</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Relacionado</label>
                    <input type="text" id="imagemRelacionado" placeholder="Ex: Rota #123, Encomenda #456">
                </div>
                <button type="submit" class="btn-primary">Upload Imagem</button>
            </form>
        </div>
    </div>

    <!-- Modal Retirada de Estoque -->
    <div id="retiradaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Retirada de Estoque</h3>
                <button class="close-btn" onclick="closeModal('retiradaModal')">&times;</button>
            </div>
            <form id="retiradaForm">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="retiradaTipo" onchange="updateRetiradaItemOptions()" required>
                        <option value="material">Mat√©ria-Prima</option>
                        <option value="municao">Muni√ß√µes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="retiradaItem" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="retiradaQuantidade" min="1" value="1" required>
                </div>
                <button type="submit" class="btn-primary">Confirmar Retirada</button>
            </form>
        </div>
    </div>

    <!-- Modal Sa√≠da Avulsa -->
    <div id="saidaAvulsaModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Sa√≠da Avulsa</h3>
                <button class="close-btn" onclick="closeModal('saidaAvulsaModal')">&times;</button>
            </div>
            <form id="saidaAvulsaForm">
                <div class="form-group">
                    <label>Tipo</label>
                    <select id="saidaAvulsaTipo" onchange="updateSaidaItemOptions()" required>
                        <option value="material">Mat√©ria-Prima</option>
                        <option value="municao">Muni√ß√µes</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Item</label>
                    <select id="saidaAvulsaItem" required>
                        <option value="">Selecione...</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Quantidade</label>
                    <input type="number" id="saidaAvulsaQuantidade" min="1" value="1" required>
                </div>
                <div class="form-group">
                    <label>Destinos (Membros)</label>
                    <select id="saidaAvulsaDestinos" multiple required>
                    </select>
                    <small style="color: #7f8c8d;">Segure Ctrl ou Cmd para selecionar v√°rios membros</small>
                </div>
                <button type="submit" class="btn-primary">Confirmar Sa√≠da</button>
            </form>
        </div>
    </div>

    <!-- Modal Editar Membro -->
    <div id="editMembroModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Editar Membro</h3>
                <button class="close-btn" onclick="closeModal('editMembroModal')">&times;</button>
            </div>
            <form id="editMembroForm">
                <input type="hidden" id="editMembroId">
                <div class="form-group">
                    <label>Nome Completo</label>
                    <input type="text" id="editMembroNome" required>
                </div>
                <div class="form-group">
                    <label>RG</label>
                    <input type="text" id="editMembroRG" required>
                </div>
                <div class="form-group">
                    <label>Telefone</label>
                    <input type="tel" id="editMembroTelefone" placeholder="(DD) XXXXX‚ÄëXXXX">
                </div>
                <div class="form-group">
                    <label>Cargo</label>
                    <select id="editMembroCargo">
                        <option value="membro">Membro</option>
                        <option value="gerente">Gerente</option>
                        <option value="lider">L√≠der</option>
                    </select>
                </div>
                <button type="submit" class="btn-primary">Salvar Altera√ß√µes</button>
            </form>
        </div>
    </div>

    <!-- Modal Pagamento -->
    <div id="pagamentoModal" class="modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3 class="modal-title">Lan√ßar Pagamento</h3>
                <button class="close-btn" onclick="closeModal('pagamentoModal')">&times;</button>
            </div>
            <form id="pagamentoForm">
                <!-- Guarda o id da rota para a qual o pagamento ser√° lan√ßado -->
                <input type="hidden" id="pagamentoRotaId">
                <div class="form-group">
                    <label>L√≠der respons√°vel</label>
                    <select id="pagamentoLiderSelect" required></select>
                </div>
                <button type="submit" class="btn-primary">Confirmar Pagamento</button>
            </form>
        </div>
    </div>
    <script>
        const API_BASE = '/api';
        let currentUser = null;
        let membros = [];
        let rotas = [];
        let encomendas = [];
// Armazena o ID da encomenda sendo editada. Se null, o formul√°rio cria uma nova.
let editingEncomendaId = null;
        // Vers√µes filtradas usadas no dashboard. Por padr√£o, apontam para os arrays completos.
        let rotasFiltradas = [];
        let encomendasFiltradas = [];
        let estoque = { materiais: [], municoes: [] };

        // Custo aproximado de mat√©rias-primas para produzir uma muni√ß√£o.  Este valor
        // corresponde ao consumo de 55 unidades de cada um dos quatro materiais
        // principais (Alum√≠nio, Cobre, Emb Pl√°stica e Ferro) e 2 unidades de
        // Tit√¢nio por 200 muni√ß√µes, multiplicado pelos respectivos pre√ßos. Se
        // os pre√ßos dos materiais forem alterados no banco de dados, este
        // valor dever√° ser recalculado no backend e enviado ao frontend. Por
        // enquanto usamos um valor fixo baseado nos pre√ßos iniciais.
        // Custos aproximados de mat√©rias‚Äëprimas por calibre de muni√ß√£o.
        // Cada valor √© calculado multiplicando a quantidade consumida de cada mat√©ria‚Äëprima
        // (alum√≠nio, cobre, embalagem pl√°stica e ferro) pelo seu pre√ßo unit√°rio (R$‚ÄØ24,50)
        // e a quantidade de tit√¢nio pelo pre√ßo unit√°rio (R$‚ÄØ24,62), dividido pela quantidade
        // de muni√ß√µes produzidas no lote (1000). Estes valores permitem calcular o custo
        // de insumos de forma individual para cada calibre em vez de um √∫nico valor fixo.
        const MATERIAL_COST_5MM = 12.3731;   // 4√ó125 unidades de materiais principais + 5 unidades de tit√¢nio para 1000 muni√ß√µes
        const MATERIAL_COST_9MM = 19.7231;   // 4√ó200 + 5
        const MATERIAL_COST_762MM = 27.1962; // 4√ó275 + 10
        const MATERIAL_COST_12CBC = 27.1962; // 4√ó275 + 10

        // Custos de fabrica√ß√£o por unidade de muni√ß√£o. Estes valores s√£o baseados
        // no custo total de produ√ß√£o de 200 unidades informado pelo usu√°rio
        // (5 mm: R$ 8.400 para 200 -> R$ 42,00 por unidade; 9 mm: R$ 10.500
        // para 200 -> R$ 52,50 por unidade; 762 mm e 12 cbc: R$ 17.500 para
        // 200 -> R$ 87,50 por unidade). Estes custos s√£o subtra√≠dos no c√°lculo
        // do lucro ap√≥s a comiss√£o e o custo dos materiais.
        const FAB_COST_5MM = 42.00;
        const FAB_COST_9MM = 52.50;
        const FAB_COST_762MM = 87.50;
        const FAB_COST_12CBC = 87.50;

        // Inicializa√ß√£o
        document.addEventListener('DOMContentLoaded', function() {
            checkAuth();
            loadUserInfo();
            loadDashboardData();
            setupDateDefaults();
        });

        function checkAuth() {
            const token = localStorage.getItem('authToken');
            if (!token) {
                window.location.href = '/static/login_simple.html';
                return;
            }
        }

        async function loadUserInfo() {
            try {
                const user = JSON.parse(localStorage.getItem('user') || '{}');
                document.getElementById('userName').textContent = user.nome_completo || 'Tofu - Administrador';
                currentUser = user;

                // Exibe ou oculta bot√µes de administra√ß√£o conforme o papel do usu√°rio.
                const addFamiliaBtn = document.getElementById('btnAddFamilia');
                if (addFamiliaBtn) {
                    // Exibe o bot√£o de cadastro de fam√≠lias para administradores, gerentes ou l√≠deres
                    if (user.role === 'admin' || user.role === 'gerente' || user.role === 'lider') {
                        addFamiliaBtn.style.display = 'inline-block';
                    } else {
                        addFamiliaBtn.style.display = 'none';
                    }
                }

                // Exibe o bot√£o de adicionar itens no estoque apenas para administradores ou l√≠deres
                const addEstoqueBtn = document.getElementById('btnAddEstoque');
                if (addEstoqueBtn) {
                    if (user.role === 'admin' || user.role === 'lider') {
                        addEstoqueBtn.style.display = 'inline-block';
                    } else {
                        addEstoqueBtn.style.display = 'none';
                    }
                }

                // Exibe o bot√£o de retirada de estoque apenas para administradores ou l√≠deres
                const retiradaBtn = document.getElementById('btnRetiradaEstoque');
                if (retiradaBtn) {
                    if (user.role === 'admin' || user.role === 'lider') {
                        retiradaBtn.style.display = 'inline-block';
                    } else {
                        retiradaBtn.style.display = 'none';
                    }
                }

                // Carrega e exibe a configura√ß√£o de taxa de comiss√£o conforme o papel do usu√°rio
                loadCommissionRate();
                // Exibe o bot√£o de sa√≠da avulsa apenas para l√≠deres
                const saidaBtn = document.getElementById('btnSaidaAvulsa');
                if (saidaBtn) {
                    if (user.role === 'lider') {
                        saidaBtn.style.display = 'inline-block';
                    } else {
                        saidaBtn.style.display = 'none';
                    }
                }

                // Exibe o bot√£o de invent√°rio para cargos de lideran√ßa (admin/gerente/lider)
                const inventarioBtn = document.getElementById('btnInventario');
                if (inventarioBtn) {
                    if (user.role === 'admin' || user.role === 'gerente' || user.role === 'lider') {
                        inventarioBtn.style.display = 'inline-block';
                    } else {
                        inventarioBtn.style.display = 'none';
                    }
                }

                // Atualiza o selo de papel do usu√°rio (badge) na interface
                const userBadge = document.getElementById('userBadge');
                if (userBadge && user.role) {
                    userBadge.textContent = user.role.toUpperCase();
                }
            } catch (error) {
                console.error('Erro ao carregar informa√ß√µes do usu√°rio:', error);
            }
        }

        async function loadDashboardData() {
            try {
                await Promise.all([
                    loadMembros(),
                    loadRotas(),
                    loadEncomendas(),
                    loadEstoque()
                ]);
                // Inicializa as listas filtradas como c√≥pias completas
                rotasFiltradas = rotas;
                encomendasFiltradas = encomendas;
                // Prepara a lista de membros no filtro do dashboard
                setupDashboardFilters();
                updateDashboardStats();
            } catch (error) {
                console.error('Erro ao carregar dados do dashboard:', error);
            }
        }

        function updateDashboardStats() {
            // Total de membros sempre considera a lista completa
            document.getElementById('totalMembros').textContent = membros.length;

            // Utiliza as listas filtradas (rotasFiltradas e encomendasFiltradas) para calcular m√©tricas
            // Calcula rotas esperadas no per√≠odo (meta: 1 rota por dia por membro)
            let deliveredCount = 0;
            let expectedCount = 0;
            const startEl = document.getElementById('dashboardStart');
            const endEl = document.getElementById('dashboardEnd');
            const memberSelect = document.getElementById('dashboardMembroSelect');
            if (startEl && endEl && memberSelect) {
                const startDate = new Date(startEl.value);
                const endDate = new Date(endEl.value);
                if (!isNaN(startDate.getTime()) && !isNaN(endDate.getTime())) {
                    // N√∫mero de dias no intervalo (inclusive)
                    const msPerDay = 24 * 60 * 60 * 1000;
                    const daysDiff = Math.floor((endDate - startDate) / msPerDay) + 1;
                    // N√∫mero de membros considerados (1 se membro espec√≠fico, sen√£o total de membros)
                    // Considera apenas membros com cargo "membro" para c√°lculo de metas de rotas
                    const membrosAtivos = membros.filter(m => (m.cargo || 'membro') === 'membro');
                    const membrosConsiderados = memberSelect.value && memberSelect.value !== '' ? 1 : membrosAtivos.length;
                    expectedCount = daysDiff * membrosConsiderados;
                    // Conta rotas entregues no per√≠odo filtrado
                    deliveredCount = (rotasFiltradas || rotas).filter(r => r.status === 'entregue').length;
                }
            }
            const pendentesCalculado = Math.max(expectedCount - deliveredCount, 0);
            document.getElementById('rotasPendentesDash').textContent = pendentesCalculado;
            const rotasEntreguesEl = document.getElementById('rotasEntreguesDash');
            if (rotasEntreguesEl) {
                rotasEntreguesEl.textContent = `+${deliveredCount} entregues`;
            }

            const encomendasPendentes = (encomendasFiltradas || encomendas).filter(e => e.status !== 'entregue').length;
            const encomendasEntregues = (encomendasFiltradas || encomendas).filter(e => e.status === 'entregue').length;
            document.getElementById('encomendasResumo').textContent = encomendasPendentes;
            const encomendasEntreguesEl = document.getElementById('encomendasEntreguesDash');
            if (encomendasEntreguesEl) {
                encomendasEntreguesEl.textContent = `+${encomendasEntregues} entregues`;
            }

            // Calcula total de vendas e comiss√µes somando encomendas filtradas
            let totalVendas = 0;
            let totalComissoes = 0;
            (encomendasFiltradas || encomendas).forEach(e => {
                if (e.valor_total) {
                    totalVendas += parseFloat(e.valor_total);
                }
                if (e.comissao) {
                    totalComissoes += parseFloat(e.comissao);
                }
            });
            const vendasEl = document.getElementById('totalVendasDash');
            if (vendasEl) {
                vendasEl.textContent = `R$ ${totalVendas.toFixed(2)}`;
            }
            const comissoesEl = document.getElementById('totalComissoesDash');
            if (comissoesEl) {
                comissoesEl.textContent = `+R$ ${totalComissoes.toFixed(2)} comiss√µes`;
            }

            // Calcula meta de rotas do m√™s atual e quantas rotas foram entregues
            const now = new Date();
            const firstDay = new Date(now.getFullYear(), now.getMonth(), 1);
            const lastDay = new Date(now.getFullYear(), now.getMonth() + 1, 0);
            const diasNoMes = lastDay.getDate();
            // Considera apenas membros com cargo "membro" para c√°lculo de metas mensais
            const membrosBase = membros.filter(m => (m.cargo || 'membro') === 'membro');
            const metaTotalMes = diasNoMes * membrosBase.length;
            // Conta rotas entregues no m√™s corrente
            let entreguesMes = 0;
            rotas.forEach(r => {
                if (r.status === 'entregue') {
                    const d = new Date(r.data_entrega);
                    if (d.getMonth() === now.getMonth() && d.getFullYear() === now.getFullYear()) {
                        entreguesMes += 1;
                    }
                }
            });
            const metaRotasEl = document.getElementById('metaRotasDash');
            const metaDiffEl = document.getElementById('metaRotasDiffDash');
            if (metaRotasEl && metaDiffEl) {
                metaRotasEl.textContent = metaTotalMes;
                if (entreguesMes >= metaTotalMes) {
                    metaDiffEl.textContent = 'Meta atingida';
                    metaDiffEl.style.color = '#2ecc71';
                } else {
                    const faltam = metaTotalMes - entreguesMes;
                    metaDiffEl.textContent = `${faltam} para bater a meta`;
                    metaDiffEl.style.color = '#f39c12';
                }
            }

            // Calcula o valor total em estoque de materiais e muni√ß√µes
            let valorMateriais = 0;
            let valorMunicoes = 0;
            if (estoque && Array.isArray(estoque.materiais)) {
                estoque.materiais.forEach(item => {
                    const q = parseFloat(item.quantidade) || 0;
                    const p = parseFloat(item.preco) || 0;
                    valorMateriais += q * p;
                });
            }
            if (estoque && Array.isArray(estoque.municoes)) {
                estoque.municoes.forEach(item => {
                    const q = parseFloat(item.quantidade) || 0;
                    const p = parseFloat(item.preco) || 0;
                    valorMunicoes += q * p;
                });
            }
            const valMatEl = document.getElementById('valorMateriaisDash');
            if (valMatEl) {
                valMatEl.textContent = `R$ ${valorMateriais.toFixed(2)}`;
            }
            const valMuniEl = document.getElementById('valorMunicoesDash');
            if (valMuniEl) {
                valMuniEl.textContent = `R$ ${valorMunicoes.toFixed(2)}`;
            }
        }

        function setupDateDefaults() {
            const hoje = new Date().toISOString().split('T')[0];
            document.getElementById('dataInicio').value = hoje;
            document.getElementById('dataFim').value = hoje;
            
            // Listener para per√≠odo personalizado
            document.getElementById('periodoRelatorio').addEventListener('change', function() {
                const isPersonalizado = this.value === 'personalizado';
                document.getElementById('dataInicioGroup').style.display = isPersonalizado ? 'block' : 'none';
                document.getElementById('dataFimGroup').style.display = isPersonalizado ? 'block' : 'none';
            });
        }

        // Prepara os filtros do dashboard: define valores padr√£o de datas e popula a lista de membros
        function setupDashboardFilters() {
            const today = new Date();
            // Define o filtro padr√£o para o m√™s atual: primeiro dia e √∫ltimo dia do m√™s
            const start = new Date(today.getFullYear(), today.getMonth(), 1);
            const end = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            const startInput = document.getElementById('dashboardStart');
            const endInput = document.getElementById('dashboardEnd');
            if (startInput) startInput.value = start.toISOString().split('T')[0];
            if (endInput) endInput.value = end.toISOString().split('T')[0];
            const select = document.getElementById('dashboardMembroSelect');
            if (select) {
                select.innerHTML = '<option value="">Todos</option>';
                membros.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.nome;
                    option.textContent = m.nome;
                    select.appendChild(option);
                });
            }

            // Sempre que o usu√°rio alterar os filtros, aplica diretamente
            if (startInput) {
                startInput.removeEventListener('change', applyDashboardFilters);
                startInput.addEventListener('change', applyDashboardFilters);
            }
            if (endInput) {
                endInput.removeEventListener('change', applyDashboardFilters);
                endInput.addEventListener('change', applyDashboardFilters);
            }
            if (select) {
                select.removeEventListener('change', applyDashboardFilters);
                select.addEventListener('change', applyDashboardFilters);
            }
        }

        // Aplica os filtros selecionados no dashboard para rotas e encomendas
        function applyDashboardFilters() {
            const startVal = document.getElementById('dashboardStart').value;
            const endVal = document.getElementById('dashboardEnd').value;
            const member = document.getElementById('dashboardMembroSelect').value;
            const startDate = startVal ? new Date(startVal) : null;
            const endDate = endVal ? new Date(endVal) : null;
            rotasFiltradas = rotas.filter(r => {
                const date = new Date(r.data_entrega);
                const memberMatch = !member || r.membro_nome === member;
                const startOk = !startDate || date >= startDate;
                const endOk = !endDate || date <= endDate;
                return memberMatch && startOk && endOk;
            });
            encomendasFiltradas = encomendas.filter(e => {
                const date = new Date(e.data_criacao);
                const startOk = !startDate || date >= startDate;
                const endOk = !endDate || date <= endDate;
                return startOk && endOk;
            });
            updateDashboardStats();
        }

        // Navega√ß√£o entre abas
        function showTab(tabName) {
            console.log('showTab called with:', tabName);
            
            // Remove active class from all tabs and tab contents
            document.querySelectorAll('.nav-tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.remove('active');
                content.style.display = 'none';
            });
            
            // Find and activate the clicked tab button
            const clickedTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (clickedTab) {
                clickedTab.classList.add('active');
            }
            
            // Add active class to corresponding content and force display
            const tabContent = document.getElementById(tabName);
            if (tabContent) {
                tabContent.classList.add('active');
                tabContent.style.display = 'block';
                console.log('Tab content activated:', tabName);
            } else {
                console.error('Tab content not found:', tabName);
            }
            
            // Load data based on tab
            switch(tabName) {
                case 'membros':
                    loadMembros();
                    break;
                case 'rotas':
                    loadRotas();
                    break;
                case 'encomendas':
                    console.log('Loading encomendas...');
                    loadEncomendas();
                    break;
                case 'estoque':
                    loadEstoque();
                    break;
                case 'relatorios':
                    loadRelatorios();
                    break;
                case 'imagens':
                    loadImagens();
                    break;
                case 'inventarioFamilia':
                    loadInventarioFamilia();
                    break;
            }
        }

        // Fun√ß√µes de Modal
        function openModal(modalId) {
            document.getElementById(modalId).style.display = 'block';
            
            if (modalId === 'rotaModal') {
                loadMembrosSelect();
            } else if (modalId === 'encomendaModal') {
                // Carrega fam√≠lias cadastradas e membros respons√°veis pela venda e calcula o valor total.
                loadFamilias();
                // Preenche o seletor de usu√°rio com todos os usu√°rios (membros, gerentes e l√≠deres)
                if (typeof loadUsuarios === 'function') {
                    loadUsuarios();
                }
                calcularTotal();
            } else if (modalId === 'retiradaModal') {
                updateRetiradaItemOptions();
            } else if (modalId === 'saidaAvulsaModal') {
                updateSaidaItemOptions();
                populateSaidaDestinos();
            } else if (modalId === 'inventarioModal') {
                // Carrega o invent√°rio de materiais e muni√ß√µes
                if (typeof loadInventario === 'function') {
                    loadInventario();
                }
            }
        }

        function closeModal(modalId) {
            document.getElementById(modalId).style.display = 'none';
        }

        // Carregar Membros
        async function loadMembros() {
            try {
                document.getElementById('membrosLoading').style.display = 'block';
                document.getElementById('membrosTable').style.display = 'none';

                const response = await fetch(`${API_BASE}/membros`);
                const data = await response.json();

                if (response.ok) {
                    membros = data;
                    renderMembrosTable(data);
                    document.getElementById('membrosLoading').style.display = 'none';
                    document.getElementById('membrosTable').style.display = 'block';
                    // Carrega solicita√ß√µes pendentes, se aplic√°vel
                    loadPendentes();
                } else {
                    throw new Error(data.error || 'Erro ao carregar membros');
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('membrosLoading').innerHTML = `<div class="error-message">Erro ao carregar membros: ${error.message}</div>`;
            }
        }

        // Carregar solicita√ß√µes pendentes de cadastro (usu√°rios inativos)
        async function loadPendentes() {
            // Apenas mostrar para cargos de lideran√ßa
            if (!currentUser || (currentUser.role !== 'admin' && currentUser.role !== 'gerente' && currentUser.role !== 'lider')) {
                document.getElementById('pendentesCard').style.display = 'none';
                return;
            }
            document.getElementById('pendentesLoading').style.display = 'block';
            document.getElementById('pendentesTable').style.display = 'none';
            try {
                const response = await fetch(`${API_BASE}/usuarios/pendentes`, {
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    renderPendentesTable(data);
                    document.getElementById('pendentesLoading').style.display = 'none';
                    document.getElementById('pendentesTable').style.display = data.length > 0 ? 'block' : 'none';
                    document.getElementById('pendentesCard').style.display = 'block';
                } else {
                    document.getElementById('pendentesLoading').innerHTML = `<div class="error-message">Erro ao carregar solicita√ß√µes: ${data.error}</div>`;
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('pendentesLoading').innerHTML = `<div class="error-message">Erro ao carregar solicita√ß√µes: ${error.message}</div>`;
            }
        }

        function renderPendentesTable(pendentes) {
            const tbody = document.getElementById('pendentesTableBody');
            tbody.innerHTML = '';
            if (!pendentes || pendentes.length === 0) {
                const tr = document.createElement('tr');
                const td = document.createElement('td');
                td.colSpan = 6;
                td.style.textAlign = 'center';
                td.style.color = '#bdc3c7';
                td.style.padding = '20px';
                td.textContent = 'Nenhuma solicita√ß√£o pendente';
                tr.appendChild(td);
                tbody.appendChild(tr);
                return;
            }
            pendentes.forEach(p => {
                const tr = document.createElement('tr');
                // Usu√°rio (username)
                const tdUser = document.createElement('td');
                tdUser.textContent = p.username || '';
                tr.appendChild(tdUser);
                // Nome
                const tdNome = document.createElement('td');
                tdNome.textContent = p.nome || '-';
                tr.appendChild(tdNome);
                // RG
                const tdRg = document.createElement('td');
                tdRg.textContent = p.rg || '-';
                tr.appendChild(tdRg);
                // Telefone
                const tdTel = document.createElement('td');
                tdTel.textContent = p.telefone || '-';
                tr.appendChild(tdTel);
                // Cargo (select)
                const tdCargo = document.createElement('td');
                const selectCargo = document.createElement('select');
                selectCargo.style.padding = '4px';
                ['membro','gerente','lider'].forEach(c => {
                    const opt = document.createElement('option');
                    opt.value = c;
                    opt.textContent = c.charAt(0).toUpperCase() + c.slice(1);
                    if (p.cargo === c) opt.selected = true;
                    selectCargo.appendChild(opt);
                });
                tdCargo.appendChild(selectCargo);
                tr.appendChild(tdCargo);
                // A√ß√µes
                const tdAcoes = document.createElement('td');
                const btnAprovar = document.createElement('button');
                btnAprovar.textContent = 'Aprovar';
                btnAprovar.className = 'btn-primary';
                btnAprovar.style.marginRight = '5px';
                btnAprovar.onclick = () => {
                    aprovarUsuario(p.user_id, selectCargo.value);
                };
                tdAcoes.appendChild(btnAprovar);
                tr.appendChild(tdAcoes);
                tbody.appendChild(tr);
            });
        }

        // Aprovar usu√°rio pendente
        async function aprovarUsuario(userId, novoCargo) {
            if (!confirm('Tem certeza que deseja aprovar este usu√°rio?')) return;
            try {
                const response = await fetch(`${API_BASE}/usuarios/${userId}/ativar`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    },
                    body: JSON.stringify({ role: novoCargo, cargo: novoCargo })
                });
                const data = await response.json();
                if (response.ok) {
                    alert('Usu√°rio aprovado com sucesso');
                    // Recarrega membros e pendentes
                    loadMembros();
                    loadPendentes();
                    // Atualiza contagem de membros no dashboard
                    updateDashboardStats();
                } else {
                    alert(data.error || 'Erro ao aprovar usu√°rio');
                }
            } catch (error) {
                console.error('Erro:', error);
                alert('Erro ao aprovar usu√°rio');
            }
        }

        // Carrega lista de respons√°veis (vendedores) para sele√ß√£o na encomenda.
        //
        // Anteriormente este m√©todo buscava a lista de contas de usu√°rio (`/api/usuarios`),
        // o que fazia com que apenas contas ativas de login fossem exibidas no combo de
        // "Usu√°rio" da encomenda. Como muitos membros podem n√£o ter uma conta de login
        // associada (por exemplo, membros cadastrados pelo l√≠der apenas para controle
        // interno), a sele√ß√£o acabava mostrando somente administradores ou l√≠deres e
        // ignorava membros como "Sincero".  Para exibir todos os membros ativos
        // (inclusive aqueles sem conta de usu√°rio), a fun√ß√£o agora consulta a API
        // de membros (`/api/membros`) e popula o select com o nome de cada membro
        // ativo.  Caso haja uma conta de usu√°rio autenticada, ela continua sendo
        // selecionada por padr√£o quando o formul√°rio √© aberto.
        async function loadUsuarios() {
            try {
                // Busca membros ativos no backend.  A rota `/api/membros` retorna apenas
                // registros com `ativo = 1` por padr√£o.
                const response = await fetch(`${API_BASE}/membros`);
                const data = await response.json();
                const select = document.getElementById('encomendaUsuarioSelect');
                if (!select) return;
                // Limpa op√ß√µes existentes
                select.innerHTML = '';
                data.forEach(membro => {
                    // Cada op√ß√£o usa o nome do membro como valor e texto.  Ao
                    // salvar a encomenda, esse valor ser√° enviado no campo
                    // `usuario`, permitindo identificar o respons√°vel pela venda.
                    const option = document.createElement('option');
                    option.value = membro.nome;
                    option.textContent = membro.nome;
                    select.appendChild(option);
                });
                // Seleciona o usu√°rio atual como padr√£o (caso exista) se o seu
                // nome corresponder a um membro cadastrado.
                if (currentUser && currentUser.username) {
                    // Tenta encontrar uma op√ß√£o cujo texto seja igual ao
                    // username autenticado; se existir, seleciona-a.
                    const currentOption = Array.from(select.options).find(opt => opt.value === currentUser.username);
                    if (currentOption) {
                        select.value = currentUser.username;
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar membros para a encomenda:', error);
            }
        }

        function renderMembrosTable(membros) {
            const tbody = document.getElementById('membrosTableBody');
            tbody.innerHTML = '';

            membros.forEach(membro => {
                const row = document.createElement('tr');
                // Constr√≥i as a√ß√µes: sempre incluir bot√£o Excluir; se usu√°rio atual tiver permiss√µes de admin/gerente/lider, incluir bot√£o Editar
                let acoes = '';
                // Editar (permite alterar nome, RG e cargo)
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'gerente' || currentUser.role === 'lider')) {
                    acoes += `<button class="btn-secondary" style="background: #3498db; padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="openEditMembroModal(${membro.id})">Editar</button>`;
                }
                // Excluir
                acoes += `<button class="btn-primary" style="background: #e74c3c; padding: 6px 12px; font-size: 12px;" onclick="deleteMembro(${membro.id})">Excluir</button>`;

                row.innerHTML = `
                    <td>${membro.nome}</td>
                    <td>${membro.rg}</td>
                    <td>${membro.telefone || '-'}</td>
                    <td>${membro.cargo || 'membro'}</td>
                    <td>${new Date(membro.data_criacao || membro.data_cadastro).toLocaleDateString('pt-BR')}</td>
                    <td>${acoes}</td>
                `;
                tbody.appendChild(row);
            });
        }

        /**
         * Abre o modal de edi√ß√£o de membro com os dados pr√©-preenchidos.
         * Somente usu√°rios com permiss√£o (admin/gerente/lider) devem conseguir abrir este modal.
         */
        function openEditMembroModal(membroId) {
            // Busca o membro pelo id na lista de membros carregada
            const membro = membros.find(m => m.id === membroId);
            if (!membro) {
                alert('Membro n√£o encontrado');
                return;
            }
            document.getElementById('editMembroId').value = membro.id;
            document.getElementById('editMembroNome').value = membro.nome;
            document.getElementById('editMembroRG').value = membro.rg;
            // Preenche telefone se existir
            const telInput = document.getElementById('editMembroTelefone');
            if (telInput) {
                telInput.value = membro.telefone || '';
            }
            document.getElementById('editMembroCargo').value = membro.cargo || 'membro';
            document.getElementById('editMembroModal').style.display = 'block';
        }

        // Envio do formul√°rio de edi√ß√£o de membro
        document.getElementById('editMembroForm').addEventListener('submit', async function(event) {
            event.preventDefault();
            const id = document.getElementById('editMembroId').value;
            const nome = document.getElementById('editMembroNome').value;
            const rg = document.getElementById('editMembroRG').value;
            const telefone = document.getElementById('editMembroTelefone').value;
            const cargo = document.getElementById('editMembroCargo').value;
            if (!id || !nome || !rg) {
                alert('Todos os campos s√£o obrigat√≥rios');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/membros/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        // Recupera o token salvo no login. A chave utilizada √© 'authToken'.
                        'Authorization': 'Bearer ' + localStorage.getItem('authToken')
                    },
                    body: JSON.stringify({ nome, rg, telefone, cargo })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Membro atualizado com sucesso!');
                    closeModal('editMembroModal');
                    loadMembros();
                } else {
                    alert(data.error || 'Erro ao atualizar membro');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        });

        async function loadMembrosSelect() {
            const select = document.getElementById('rotaMembro');
            select.innerHTML = '<option value="">Selecione um membro...</option>';
            
            // Apenas membros com cargo "membro" devem aparecer na lista para rotas manuais
            membros.forEach(membro => {
                const cargo = membro.cargo || 'membro';
                if (cargo === 'membro') {
                    const option = document.createElement('option');
                    option.value = membro.id;
                    option.textContent = membro.nome;
                    select.appendChild(option);
                }
            });
        }

        // Fun√ß√£o para excluir um membro
        async function deleteMembro(id) {
            if (!confirm('Deseja realmente excluir este membro?')) {
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/membros/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? 'Bearer ' + token : undefined
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Membro exclu√≠do com sucesso!');
                    loadMembros();
                } else {
                    alert(data.error || 'Erro ao excluir membro');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        // Carregar Rotas
        async function loadRotas() {
            try {
                document.getElementById('rotasLoading').style.display = 'block';
                document.getElementById('rotasTable').style.display = 'none';

                const response = await fetch(`${API_BASE}/rotas`);
                const data = await response.json();

                if (response.ok) {
                    rotas = data;
                    renderRotasTable(data);
                    document.getElementById('rotasLoading').style.display = 'none';
                    document.getElementById('rotasTable').style.display = 'block';
                    // Atualiza os indicadores do dashboard ap√≥s carregar rotas
                    updateDashboardStats();
                } else {
                    throw new Error(data.error || 'Erro ao carregar rotas');
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('rotasLoading').innerHTML = `<div class="error-message">Erro ao carregar rotas: ${error.message}</div>`;
            }
        }

        function renderRotasTable(rotas) {
            const tbody = document.getElementById('rotasTableBody');
            tbody.innerHTML = '';

            rotas.forEach(rota => {
                const row = document.createElement('tr');
                // Construir a√ß√µes dinamicamente com base no status e no papel do usu√°rio
                let acoesHTML = '';
                if (rota.status === 'pendente') {
                    // Somente administradores ou l√≠deres podem lan√ßar rotas pendentes
                    if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lider')) {
                        acoesHTML += `<button class="btn-primary" style="background: #3498db; padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="lancarRota(${rota.id})">Lan√ßar</button>`;
                    }
                }
                if (rota.status === 'entregue') {
                    // Se o pagamento ainda n√£o foi efetuado, exibe bot√£o para lan√ßar pagamento
                    if (!rota.pagamento || rota.pagamento === 0) {
                        if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lider')) {
                            acoesHTML += `<button class="btn-primary" style="background: #27ae60; padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="openPagamentoModal(${rota.id})">Pagar</button>`;
                        }
                    }
                    // Bot√£o para visualizar comprovante somente se houver caminho
                    if (rota.comprovante_path) {
                        acoesHTML += `<button class="btn-secondary" style="background: #8e44ad; padding: 6px 12px; font-size: 12px; margin-right: 5px;" onclick="verComprovante(${rota.id})">Ver Comprovante</button>`;
                    }
                }
                // Bot√£o de excluir apenas para administradores ou l√≠deres
                if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lider')) {
                    acoesHTML += `<button class="btn-primary" style="background: #e74c3c; padding: 6px 12px; font-size: 12px;" onclick="deleteRota(${rota.id})">Excluir</button>`;
                }
                row.innerHTML = `
                    <td>${rota.membro_nome}</td>
                    <td>${rota.quantidade}</td>
                    <td>${new Date(rota.data_entrega).toLocaleDateString('pt-BR')}</td>
                    <td><span style="color: ${rota.status === 'entregue' ? '#2ecc71' : '#f39c12'}">${rota.status}</span></td>
                    <td>R$ ${rota.pagamento ? parseFloat(rota.pagamento).toFixed(2) : '0.00'}</td>
                    <td>${rota.pagante_username ? rota.pagante_username : '-'}</td>
                    <td>${acoesHTML}</td>
                `;
                tbody.appendChild(row);
            });
        }

        // Lan√ßar rota pendente: solicita a quantidade entregue e atualiza a rota para "entregue".
        async function lancarRota(id) {
            const quantidadeStr = prompt('Informe a quantidade entregue nesta rota:');
            if (quantidadeStr === null) {
                return; // Usu√°rio cancelou
            }
            const quantidade = parseInt(quantidadeStr, 10);
            if (isNaN(quantidade) || quantidade <= 0) {
                alert('Quantidade inv√°lida');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/rotas/${id}`, {
                    method: 'PUT',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ quantidade, status: 'entregue' })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Rota lan√ßada com sucesso!');
                    loadRotas();
                } else {
                    alert(data.error || 'Erro ao lan√ßar rota');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        // Visualizar comprovante associado a uma rota entregue.
        // No momento a funcionalidade mostra apenas uma mensagem, pois o upload e armazenamento de imagens ainda n√£o est√° implementado no backend.
        function verComprovante(id) {
            // Localiza a rota pelo id
            const rota = rotas.find(r => r.id === id);
            if (!rota) {
                alert('Rota n√£o encontrada');
                return;
            }
            if (!rota.comprovante_path) {
                alert('Nenhum comprovante anexado para esta rota.');
                return;
            }
            // Caso exista um caminho, abre em nova aba
            window.open(rota.comprovante_path, '_blank');
        }

        // Excluir rota (somente para administradores/gerentes/l√≠deres)
        async function deleteRota(id) {
            if (!confirm('Deseja realmente excluir esta rota?')) {
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/rotas/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? 'Bearer ' + token : undefined
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Rota exclu√≠da com sucesso!');
                    loadRotas();
                } else {
                    alert(data.error || 'Erro ao excluir rota');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        // Lan√ßa pagamento de uma rota entregue solicitando a sele√ß√£o de um l√≠der respons√°vel.
        // Esta fun√ß√£o √© mantida por compatibilidade, mas agora apenas abre o modal de pagamento.
        async function lancarPagamento(id) {
            openPagamentoModal(id);
        }

        // Excluir encomenda (somente para administradores/gerentes/l√≠deres)
        async function deleteEncomenda(id) {
            if (!confirm('Deseja realmente excluir esta encomenda?')) {
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/encomendas/${id}`, {
                    method: 'DELETE',
                    headers: {
                        'Authorization': token ? 'Bearer ' + token : undefined
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Encomenda exclu√≠da com sucesso!');
                    loadEncomendas();
                } else {
                    alert(data.error || 'Erro ao excluir encomenda');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        // Cancelar encomenda (define status como cancelado e devolve estoque se necess√°rio)
        async function cancelarEncomenda(id) {
            if (!confirm('Deseja realmente cancelar esta encomenda?')) {
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                // Encontra a encomenda para obter dados atuais
                const encomenda = encomendas.find(e => e.id === id);
                if (!encomenda) {
                    alert('Encomenda n√£o encontrada');
                    return;
                }
                // Envia requisi√ß√£o de atualiza√ß√£o para status cancelado
                const response = await fetch(`${API_BASE}/encomendas/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? 'Bearer ' + token : undefined
                    },
                    body: JSON.stringify({
                        cliente: encomenda.cliente,
                        familia: encomenda.familia,
                        telefone_cliente: encomenda.telefone_cliente,
                        municao_5mm: encomenda.municao_5mm,
                        municao_9mm: encomenda.municao_9mm,
                        municao_762mm: encomenda.municao_762mm,
                        municao_12cbc: encomenda.municao_12cbc,
                        valor_total: encomenda.valor_total,
                        comissao: encomenda.comissao,
                        status: 'cancelado',
                        usuario: encomenda.usuario
                    })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Encomenda cancelada com sucesso!');
                    loadEncomendas();
                    updateDashboardStats();
                } else {
                    alert(data.error || 'Erro ao cancelar encomenda');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        // Carregar Encomendas - REFATORADA DO ZERO
        async function loadEncomendas() {
            console.log('=== CARREGANDO ENCOMENDAS ===');
            
            try {
                const response = await fetch(`${API_BASE}/encomendas`);
                console.log('Response status:', response.status);
                
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                
                const data = await response.json();
                console.log('Encomendas carregadas:', data);
                
                encomendas = data;
                // Mant√©m uma refer√™ncia global a todas as encomendas para c√°lculos de reservas
                window.allEncomendas = data;
                // Aplica filtro selecionado antes de renderizar
                applyEncomendaFilter();
                // Atualiza indicadores do dashboard ap√≥s carregar encomendas
                updateDashboardStats();
                
                console.log('=== ENCOMENDAS CARREGADAS COM SUCESSO ===');
                
            } catch (error) {
                console.error('Erro ao carregar encomendas:', error);
                const tbody = document.getElementById('encomendasTableBody');
                if (tbody) {
                    tbody.innerHTML = `
                        <tr>
                            <td colspan="10" style="text-align: center; color: #e74c3c; padding: 40px;">
                                ‚ùå Erro ao carregar encomendas: ${error.message}
                            </td>
                        </tr>
                    `;
                }
            }
        }

        /**
         * Carrega a taxa de comiss√£o atual do servidor e atualiza o campo de
         * configura√ß√£o. Exibe ou oculta o painel de configura√ß√£o de acordo
         * com o papel do usu√°rio logado. Os l√≠deres e administradores podem
         * ajustar a taxa de comiss√£o; para outros usu√°rios o painel √© ocultado.
         */
        async function loadCommissionRate() {
            const container = document.getElementById('commissionRateContainer');
            const input = document.getElementById('commissionRateInput');
            if (!container || !input) return;
            // Exibir apenas para l√≠deres ou administradores
            if (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lider')) {
                container.style.display = 'flex';
            } else {
                container.style.display = 'none';
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/config/commission-rate`);
                if (!response.ok) {
                    throw new Error('Falha ao obter taxa de comiss√£o');
                }
                const data = await response.json();
                const rate = parseFloat(data.rate);
                if (!isNaN(rate)) {
                    // Armazena globalmente e atualiza o input em porcentagem
                    window.currentCommissionRate = rate;
                    input.value = (rate * 100).toFixed(2);
                }
            } catch (error) {
                console.error('Erro ao carregar taxa de comiss√£o:', error);
            }
        }

        /**
         * Envia uma nova taxa de comiss√£o ao servidor. Somente l√≠deres ou
         * administradores podem realizar a opera√ß√£o. Ap√≥s atualiza√ß√£o
         * bem-sucedida, recarrega as encomendas para aplicar o novo percentual.
         */
        async function updateCommissionRate() {
            const input = document.getElementById('commissionRateInput');
            if (!input) return;
            const valuePercent = parseFloat(input.value);
            if (isNaN(valuePercent) || valuePercent < 0 || valuePercent > 100) {
                alert('Informe um valor percentual v√°lido entre 0 e 100');
                return;
            }
            const rate = valuePercent / 100.0;
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/config/commission-rate`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? 'Bearer ' + token : undefined
                    },
                    body: JSON.stringify({ rate })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Taxa de comiss√£o atualizada com sucesso');
                    // Atualiza valor global e recarrega encomendas para refletir mudan√ßas
                    window.currentCommissionRate = rate;
                    loadEncomendas();
                } else {
                    alert(data.error || 'Erro ao atualizar taxa de comiss√£o');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        }

        function renderEncomendasTable(encomendas) {
            console.log('=== RENDERIZANDO TABELA DE ENCOMENDAS ===');
            const tbody = document.getElementById('encomendasTableBody');
            
            if (!tbody) {
                console.error('Elemento encomendasTableBody n√£o encontrado!');
                return;
            }
            
            if (!encomendas || encomendas.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="10" style="text-align: center; color: #bdc3c7; padding: 40px; font-size: 16px;">
                            üì¶ Nenhuma encomenda cadastrada<br>
                            <small>Clique em \"Nova Encomenda\" para come√ßar</small>
                        </td>
                    </tr>
                `;
                updateEncomendasStats(0, 0, 0, 0, 0, 0);
                return;
            }

            let html = '';
            let totalComissoes = 0;
            let pendentes = 0;
            let entregues = 0;
            let totalShortage = 0;
            let totalLucro = 0;

            // Calcula muni√ß√µes reservadas por encomendas prontas (n√£o entregues). Isto √©
            // necess√°rio para avaliar se uma encomenda pendente ter√° falta de
            // produ√ß√£o. As quantidades reservadas s√£o subtra√≠das do estoque
            // dispon√≠vel antes de calcular as faltas.
            // Calcula reservas a partir do conjunto completo de encomendas, n√£o apenas
            // das que est√£o sendo exibidas, pois encomendas prontas fora do filtro
            // tamb√©m consomem estoque. Usa a vari√°vel global `encomendas`.
            const reservas = { '5mm': 0, '9mm': 0, '762mm': 0, '12cbc': 0 };
            const allList = Array.isArray(window.allEncomendas) ? window.allEncomendas : encomendas;
            allList.forEach(e => {
                if (e.status === 'pronto') {
                    reservas['5mm'] += e.municao_5mm || 0;
                    reservas['9mm'] += e.municao_9mm || 0;
                    reservas['762mm'] += e.municao_762mm || 0;
                    reservas['12cbc'] += e.municao_12cbc || 0;
                }
            });

            // Mapeia o estoque atual de muni√ß√µes
            const estoqueMap = {};
            if (estoque && estoque.municoes) {
                estoque.municoes.forEach(m => {
                    estoqueMap[m.nome] = m.quantidade;
                });
            }
            // Calcula estoque dispon√≠vel ap√≥s reservar muni√ß√µes de encomendas prontas
            const available = {
                '5mm': (estoqueMap['5mm'] || 0) - reservas['5mm'],
                '9mm': (estoqueMap['9mm'] || 0) - reservas['9mm'],
                '762mm': (estoqueMap['762mm'] || 0) - reservas['762mm'],
                '12cbc': (estoqueMap['12cbc'] || 0) - reservas['12cbc'],
            };

            encomendas.forEach(encomenda => {
                const municoes = [];
                if (encomenda.municao_5mm > 0) municoes.push(`5mm: ${encomenda.municao_5mm}`);
                if (encomenda.municao_9mm > 0) municoes.push(`9mm: ${encomenda.municao_9mm}`);
                if (encomenda.municao_762mm > 0) {
                    municoes.push(`${formatMunicaoName('762mm')}: ${encomenda.municao_762mm}`);
                }
                if (encomenda.municao_12cbc > 0) municoes.push(`12cbc: ${encomenda.municao_12cbc}`);

                // Calcula falta de muni√ß√µes apenas para encomendas pendentes, usando o
                // estoque dispon√≠vel ap√≥s reservar encomendas prontas. Para encomendas
                // prontas ou entregues, as muni√ß√µes j√° est√£o reservadas ou faturadas.
                let shortages = [];
                let falta5 = 0; let falta9 = 0; let falta762 = 0; let falta12 = 0;
                if (encomenda.status === 'pendente') {
                    const req5 = encomenda.municao_5mm || 0;
                    const req9 = encomenda.municao_9mm || 0;
                    const req762 = encomenda.municao_762mm || 0;
                    const req12 = encomenda.municao_12cbc || 0;
                    if (req5 > (available['5mm'] || 0)) {
                        falta5 = req5 - (available['5mm'] || 0);
                        shortages.push(`5mm: ${falta5}`);
                    }
                    if (req9 > (available['9mm'] || 0)) {
                        falta9 = req9 - (available['9mm'] || 0);
                        shortages.push(`9mm: ${falta9}`);
                    }
                    if (req762 > (available['762mm'] || 0)) {
                        falta762 = req762 - (available['762mm'] || 0);
                        shortages.push(`${formatMunicaoName('762mm')}: ${falta762}`);
                    }
                    if (req12 > (available['12cbc'] || 0)) {
                        falta12 = req12 - (available['12cbc'] || 0);
                        shortages.push(`12cbc: ${falta12}`);
                    }
                    totalShortage += falta5 + falta9 + falta762 + falta12;
                }
                let shortageSpan = '';
                if (shortages.length > 0) {
                    shortageSpan = `<span style="color:#e74c3c"> (Falta: ${shortages.join(', ')})</span>`;
                }

                // Determina classe e √≠cone conforme o status
                let statusClass = 'status-pendente';
                let statusIcon = '‚è≥';
                if (encomenda.status === 'pronto') {
                    statusClass = 'status-pronto';
                    statusIcon = 'üöö';
                } else if (encomenda.status === 'entregue') {
                    statusClass = 'status-entregue';
                    statusIcon = '‚úÖ';
                } else if (encomenda.status === 'cancelado') {
                    statusClass = 'status-cancelado';
                    statusIcon = '‚ùå';
                }

                // Contabiliza para estat√≠sticas: pendentes consideram tamb√©m prontos e cancelados
                if (encomenda.status === 'entregue') {
                    entregues++;
                } else {
                    pendentes++;
                }
                
                totalComissoes += parseFloat(encomenda.comissao || 0);

                // Calcula lucro apenas para encomendas entregues. O lucro baseia-se
                // na f√≥rmula: venda - custo de mat√©rias-primas - comiss√£o - taxa de
                // fabrica√ß√£o. A taxa de fabrica√ß√£o √© considerada zero neste
                // exemplo. O custo de mat√©rias-primas agora √© calculado de forma
                // individual para cada calibre, multiplicando a quantidade de cada
                // muni√ß√£o pelo seu respectivo custo de insumo. Se desejar incluir
                // encomendas prontas ou pendentes na margem futura, remova a
                // verifica√ß√£o de status.
                if (encomenda.status === 'entregue') {
                    const q5 = encomenda.municao_5mm || 0;
                    const q9 = encomenda.municao_9mm || 0;
                    const q762 = encomenda.municao_762mm || 0;
                    const q12 = encomenda.municao_12cbc || 0;
                    // Custo de mat√©ria-prima aproximado, calculado individualmente por calibre
                    const materialCost = (q5 * MATERIAL_COST_5MM) + (q9 * MATERIAL_COST_9MM) + (q762 * MATERIAL_COST_762MM) + (q12 * MATERIAL_COST_12CBC);
                    // Custo de fabrica√ß√£o calculado individualmente por calibre
                    const fabCost = (q5 * FAB_COST_5MM) + (q9 * FAB_COST_9MM) + (q762 * FAB_COST_762MM) + (q12 * FAB_COST_12CBC);
                    const valorTotal = parseFloat(encomenda.valor_total || 0);
                    const comissao = parseFloat(encomenda.comissao || 0);
                    const lucro = valorTotal - materialCost - comissao - fabCost;
                    totalLucro += lucro;
                }

                // N√£o mostrar faltas se o status for entregues ou pronto (estoque j√° foi reservado)
                let shortageDisplay = shortageSpan;
                if (encomenda.status === 'entregue' || encomenda.status === 'pronto') {
                    shortageDisplay = '';
                }
                const valorLiquido = parseFloat(encomenda.valor_total || 0) - parseFloat(encomenda.comissao || 0);
                html += `
                    <tr>
                        <td data-label="Cliente">${encomenda.cliente}</td>
                        <td data-label="Fam√≠lia">${encomenda.familia}</td>
                        <td data-label="Telefone">${encomenda.telefone_cliente || ''}</td>
                        <td data-label="Vendedor">${encomenda.usuario || ''}</td>
                        <td data-label="Muni√ß√µes">${municoes.join(', ')}${shortageDisplay}</td>
                        <td data-label="Valor Total">R$ ${parseFloat(encomenda.valor_total || 0).toFixed(2)}</td>
                        <td data-label="Comiss√£o">R$ ${parseFloat(encomenda.comissao || 0).toFixed(2)}</td>
                        <td data-label="Valor L√≠quido">R$ ${valorLiquido.toFixed(2)}</td>
                        <td data-label="Status"><span class="${statusClass}">${statusIcon} ${encomenda.status}</span></td>
                        <td data-label="Data/Hora">${new Date(encomenda.data_criacao).toLocaleString('pt-BR')}</td>
                        <td data-label="A√ß√µes">
                            <!-- Bot√µes de a√ß√£o s√£o exibidos somente para administradores ou l√≠deres -->
                            ${ (currentUser && (currentUser.role === 'admin' || currentUser.role === 'lider')) ? `
                                <button class="btn-secondary btn-sm" onclick="editarEncomenda(${encomenda.id})" title="Editar">‚úèÔ∏è</button>
                                <button class="btn-danger btn-sm" onclick="deleteEncomenda(${encomenda.id})" title="Excluir">üóëÔ∏è</button>
                                <button class="btn-warning btn-sm" onclick="cancelarEncomenda(${encomenda.id})" title="Cancelar">‚ùå</button>
                            ` : '' }
                        </td>
                    </tr>
                `;
            });

            tbody.innerHTML = html;
            // Chama updateEncomendasStats com par√¢metros estendidos: total, pendentes, entregues,
            // total de comiss√µes, total de faltas e total de lucro
            updateEncomendasStats(encomendas.length, pendentes, entregues, totalComissoes, totalShortage, totalLucro);
            
            console.log('=== TABELA RENDERIZADA COM SUCESSO ===');
        }

        // Fun√ß√£o para carregar rotasticas das encomendas
        function updateEncomendasStats(total, pendentes, entregues, totalComissoes) {
            const totalEl = document.getElementById('totalEncomendas');
            const pendentesEl = document.getElementById('encomendasPendentes');
            const entreguesEl = document.getElementById('encomendasEntregues');
            const comissoesEl = document.getElementById('totalComissoes');
            const necessidadeEl = document.getElementById('necessidadeFabricacao');
            const lucroEl = document.getElementById('lucroTotal');

            if (totalEl) totalEl.textContent = total;
            if (pendentesEl) pendentesEl.textContent = pendentes;
            if (entreguesEl) entreguesEl.textContent = entregues;
            if (comissoesEl) comissoesEl.textContent = `R$ ${totalComissoes.toFixed(2)}`;
            // O quinto par√¢metro (necessidadeTotal) indica quantas muni√ß√µes faltam, o sexto (lucroTotal) indica o lucro estimado
            if (arguments.length > 4 && necessidadeEl) {
                const necessidadeTotal = arguments[4] || 0;
                necessidadeEl.textContent = necessidadeTotal;
            }
            if (arguments.length > 5 && lucroEl) {
                const lucroTotal = arguments[5] || 0;
                lucroEl.textContent = `R$ ${lucroTotal.toFixed(2)}`;
            }
        }

        /**
         * Aplica o filtro selecionado de encomendas (Pendentes/Prontas ou Todas).
         * Atualiza a vari√°vel global encomendasFiltradas, renderiza a tabela
         * correspondente e atualiza as estat√≠sticas do dashboard.
         */
        function applyEncomendaFilter() {
            const select = document.getElementById('encomendaStatusFiltro');
            if (!select) {
                // Se n√£o houver seletor, renderiza todas as encomendas
                encomendasFiltradas = encomendas.slice();
                renderEncomendasTable(encomendasFiltradas);
                updateDashboardStats();
                return;
            }
            const filtro = select.value;
            if (filtro === 'ativos') {
                // Mostra apenas encomendas pendentes ou prontas (n√£o entregues nem canceladas)
                encomendasFiltradas = encomendas.filter(e => e.status === 'pendente' || e.status === 'pronto');
            } else {
                // Mostra todas as encomendas
                encomendasFiltradas = encomendas.slice();
            }
            renderEncomendasTable(encomendasFiltradas);
            updateDashboardStats();
        }
        /**
         * Inicia a edi√ß√£o de uma encomenda existente.
         * Pr√©-preenche o formul√°rio de encomenda com os dados da encomenda e marca editingEncomendaId.
         * @param {number} id - Identificador da encomenda a ser editada
         */
        async function editarEncomenda(id) {
            const encomenda = encomendas.find(e => e.id === id);
            if (!encomenda) {
                alert('Encomenda n√£o encontrada');
                return;
            }
            // Define o ID em edi√ß√£o
            editingEncomendaId = id;
            // Abre o modal de encomenda
            openModal('encomendaModal');
            // Carrega fam√≠lias (garante que o select esteja preenchido)
            if (typeof loadFamilias === 'function') {
                await loadFamilias();
            }
            // Carrega usu√°rios para o select de vendedor
            if (typeof loadUsuarios === 'function') {
                await loadUsuarios();
            }
            // Preenche campos diretamente (fam√≠lias e usu√°rios j√° carregados)
            document.getElementById('encomendaCliente').value = encomenda.cliente;
            // Preenche telefone do cliente
            const telInput = document.getElementById('encomendaClienteTelefone');
            if (telInput) {
                telInput.value = encomenda.telefone_cliente || '';
            }
            const familiaSelect = document.getElementById('encomendaFamiliaSelect');
            const familiaOutroInput = document.getElementById('encomendaFamiliaOutro');
            if (familiaSelect) {
                const optionExists = Array.from(familiaSelect.options).some(opt => opt.value === encomenda.familia);
                if (optionExists) {
                    familiaSelect.value = encomenda.familia;
                    if (familiaOutroInput) {
                        familiaOutroInput.style.display = 'none';
                        familiaOutroInput.value = '';
                        familiaOutroInput.required = false;
                    }
                } else {
                    familiaSelect.value = 'outro';
                    if (familiaOutroInput) {
                        familiaOutroInput.style.display = 'block';
                        familiaOutroInput.value = encomenda.familia;
                        familiaOutroInput.required = true;
                    }
                }
            }
            const userSelect = document.getElementById('encomendaUsuarioSelect');
            if (userSelect) {
                const optExists = Array.from(userSelect.options).some(opt => opt.value === encomenda.usuario);
                if (!optExists && encomenda.usuario) {
                    const option = document.createElement('option');
                    option.value = encomenda.usuario;
                    option.textContent = encomenda.usuario;
                    userSelect.appendChild(option);
                }
                userSelect.value = encomenda.usuario || (currentUser && currentUser.username) || '';
            }
            // Quantidades e pre√ßos
            document.getElementById('municao5mm').value = encomenda.municao_5mm || 0;
            document.getElementById('preco5mm').value = 100;
            document.getElementById('municao9mm').value = encomenda.municao_9mm || 0;
            document.getElementById('preco9mm').value = 125;
            document.getElementById('municao762mm').value = encomenda.municao_762mm || 0;
            document.getElementById('preco762mm').value = 200;
            document.getElementById('municao12cbc').value = encomenda.municao_12cbc || 0;
            document.getElementById('preco12cbc').value = 200;
            const statusEl = document.getElementById('encomendaStatus');
            if (statusEl) {
                statusEl.value = encomenda.status || 'pendente';
            }
            calcularTotal();
        }

        function loadFamiliasSelect() {
            const select = document.getElementById('encomendaFamilia');
            select.innerHTML = '<option value="">Selecione uma fam√≠lia...</option>';
            
            membros.forEach(membro => {
                const option = document.createElement('option');
                option.value = membro.nome;
                option.textContent = membro.nome;
                select.appendChild(option);
            });
        }

        function calcularTotal() {
            const qtd5mm = parseInt(document.getElementById('municao5mm').value) || 0;
            const preco5mm = parseFloat(document.getElementById('preco5mm').value) || 0;
            const qtd9mm = parseInt(document.getElementById('municao9mm').value) || 0;
            const preco9mm = parseFloat(document.getElementById('preco9mm').value) || 0;
            const qtd762mm = parseInt(document.getElementById('municao762mm').value) || 0;
            const preco762mm = parseFloat(document.getElementById('preco762mm').value) || 0;
            const qtd12cbc = parseInt(document.getElementById('municao12cbc').value) || 0;
            const preco12cbc = parseFloat(document.getElementById('preco12cbc').value) || 0;

            const total = (qtd5mm * preco5mm) + (qtd9mm * preco9mm) + (qtd762mm * preco762mm) + (qtd12cbc * preco12cbc);
            const comissao = total * 0.07;

            document.getElementById('valorTotal').textContent = `R$ ${total.toFixed(2)}`;
            document.getElementById('comissaoTotal').textContent = `R$ ${comissao.toFixed(2)}`;
        }

        // Carregar Estoque
        async function loadEstoque() {
            try {
                document.getElementById('estoqueLoading').style.display = 'block';
                document.getElementById('estoqueContent').style.display = 'none';

                const response = await fetch(`${API_BASE}/estoque`);
                const data = await response.json();

                if (response.ok) {
                    // A API de estoque pode retornar um array simples ou um objeto.
                    // Se for um array, agrupamos itens por tipo para manter o formato esperado
                    // pelas fun√ß√µes de renderiza√ß√£o (materiais e municoes).
                    let result = data;
                    if (Array.isArray(data)) {
                        const materiais = data.filter(item => item.tipo === 'material');
                        const municoes = data.filter(item => item.tipo === 'municao');
                        result = { materiais, municoes };
                    }
                    estoque = result;
                    renderEstoqueTable(result);
                    document.getElementById('estoqueLoading').style.display = 'none';
                    document.getElementById('estoqueContent').style.display = 'block';
                } else {
                    throw new Error(data.error || 'Erro ao carregar estoque');
                }
            } catch (error) {
                console.error('Erro:', error);
                document.getElementById('estoqueLoading').innerHTML = `<div class="error-message">Erro ao carregar estoque: ${error.message}</div>`;
            }
        }

        function renderEstoqueTable(data) {
            const materiaisBody = document.getElementById('materiaisTableBody');
            materiaisBody.innerHTML = '';
            if (data.materiais && Array.isArray(data.materiais)) {
                // Agrupa materiais pelo nome para evitar duplicidades na exibi√ß√£o
                const groupedMat = {};
                data.materiais.forEach(mat => {
                    const key = mat.nome;
                    if (!groupedMat[key]) {
                        groupedMat[key] = { quantidade: 0, preco: parseFloat(mat.preco) };
                    }
                    groupedMat[key].quantidade += parseFloat(mat.quantidade);
                    // Mant√©m o menor pre√ßo encontrado como refer√™ncia
                    if (parseFloat(mat.preco) < groupedMat[key].preco) {
                        groupedMat[key].preco = parseFloat(mat.preco);
                    }
                });
                Object.keys(groupedMat).forEach(name => {
                    const row = document.createElement('tr');
                    row.innerHTML = `
                        <td>${name}</td>
                        <td>${groupedMat[name].quantidade}</td>
                        <td>R$ ${groupedMat[name].preco.toFixed(2)}</td>
                    `;
                    materiaisBody.appendChild(row);
                });
            }

            const municoesBody = document.getElementById('municoesTableBody');
            municoesBody.innerHTML = '';
            if (data.municoes && Array.isArray(data.municoes)) {
                // Agrupa muni√ß√µes pelo nome para evitar duplicidades na exibi√ß√£o
                const groupedMun = {};
                data.municoes.forEach(mun => {
                    const key = mun.nome || mun.tipo;
                    if (!groupedMun[key]) {
                        groupedMun[key] = { quantidade: 0, preco: parseFloat(mun.preco) };
                    }
                    groupedMun[key].quantidade += parseFloat(mun.quantidade);
                    if (parseFloat(mun.preco) < groupedMun[key].preco) {
                        groupedMun[key].preco = parseFloat(mun.preco);
                    }
                });
                Object.keys(groupedMun).forEach(name => {
                    const row = document.createElement('tr');
                    const nomeFormatado = typeof formatMunicaoName === 'function' ? formatMunicaoName(name) : name;
                    row.innerHTML = `
                        <td>${nomeFormatado}</td>
                        <td>${groupedMun[name].quantidade}</td>
                        <td>R$ ${groupedMun[name].preco.toFixed(2)}</td>
                    `;
                    municoesBody.appendChild(row);
                });
            }
        }

        /**
         * Atualiza a lista de itens dispon√≠veis para retirada conforme o tipo selecionado.
         */
        function updateRetiradaItems() {
            const tipo = document.getElementById('retiradaTipo').value;
            const select = document.getElementById('retiradaItem');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione um item...</option>';
            if (!estoque) return;
            let items = [];
            if (tipo === 'material' && estoque.materiais) {
                items = estoque.materiais;
            } else if (tipo === 'municao' && estoque.municoes) {
                items = estoque.municoes;
            }
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.nome;
                option.textContent = item.nome;
                select.appendChild(option);
            });
        }

        /**
         * Atualiza a lista de itens dispon√≠veis para sa√≠da avulsa conforme o tipo selecionado.
         */
        function updateSaidaItems() {
            const tipo = document.getElementById('saidaTipo').value;
            const select = document.getElementById('saidaItem');
            if (!select) return;
            select.innerHTML = '<option value="">Selecione um item...</option>';
            if (!estoque) return;
            let items = [];
            if (tipo === 'material' && estoque.materiais) {
                items = estoque.materiais;
            } else if (tipo === 'municao' && estoque.municoes) {
                items = estoque.municoes;
            }
            items.forEach(item => {
                const option = document.createElement('option');
                option.value = item.nome;
                option.textContent = item.nome;
                select.appendChild(option);
            });
        }

        /**
         * Popula o seletor de destinos (membros) no modal de sa√≠da avulsa.
         */
        function populateSaidaDestinos() {
            const select = document.getElementById('saidaDestinos');
            if (!select) return;
            select.innerHTML = '';
            if (Array.isArray(membros)) {
                membros.forEach(m => {
                    const option = document.createElement('option');
                    option.value = m.nome;
                    option.textContent = m.nome;
                    select.appendChild(option);
                });
            }
        }

        // Manipula o envio do formul√°rio de retirada de estoque
        document.addEventListener('DOMContentLoaded', () => {
            const retiradaForm = document.getElementById('retiradaForm');
            if (retiradaForm) {
                retiradaForm.addEventListener('submit', async function(ev) {
                    ev.preventDefault();
                    const tipo = document.getElementById('retiradaTipo').value;
                    const item = document.getElementById('retiradaItem').value;
                    const quantidade = document.getElementById('retiradaQuantidade').value;
                    if (!tipo || !item || !quantidade) {
                        alert('Preencha todos os campos');
                        return;
                    }
                    try {
                        const token = localStorage.getItem('authToken');
                        const resp = await fetch(`${API_BASE}/estoque/retirar`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? 'Bearer ' + token : undefined
                            },
                            body: JSON.stringify({ tipo, item, quantidade })
                        });
                        const data = await resp.json();
                        if (resp.ok) {
                            alert(data.message || 'Retirada registrada com sucesso');
                            closeModal('retiradaModal');
                            // Recarrega estoque
                            loadEstoque();
                        } else {
                            alert(data.error || 'Erro ao realizar retirada');
                        }
                    } catch (error) {
                        alert('Erro de conex√£o: ' + error.message);
                    }
                });
            }
            const saidaForm = document.getElementById('saidaAvulsaForm');
            if (saidaForm) {
                saidaForm.addEventListener('submit', async function(ev) {
                    ev.preventDefault();
                    const tipo = document.getElementById('saidaTipo').value;
                    const item = document.getElementById('saidaItem').value;
                    const quantidade = document.getElementById('saidaQuantidade').value;
                    const destinosSelect = document.getElementById('saidaDestinos');
                    const destinos = Array.from(destinosSelect.selectedOptions).map(opt => opt.value);
                    if (!tipo || !item || !quantidade || destinos.length === 0) {
                        alert('Preencha todos os campos e selecione pelo menos um destino');
                        return;
                    }
                    try {
                        const token = localStorage.getItem('authToken');
                        const resp = await fetch(`${API_BASE}/estoque/saida-avulsa`, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': token ? 'Bearer ' + token : undefined
                            },
                            body: JSON.stringify({ tipo, item, quantidade, destinos })
                        });
                        const data = await resp.json();
                        if (resp.ok) {
                            alert(data.message || 'Sa√≠da avulsa registrada com sucesso');
                            closeModal('saidaAvulsaModal');
                            loadEstoque();
                        } else {
                            alert(data.error || 'Erro ao registrar sa√≠da avulsa');
                        }
                    } catch (error) {
                        alert('Erro de conex√£o: ' + error.message);
                    }
                });
            }
        });

        function updateItemOptions() {
            const tipo = document.getElementById('estoqueType').value;
            const itemSelect = document.getElementById('estoqueItem');
            itemSelect.innerHTML = '<option value="">Selecione um item...</option>';

            const baixarGroup = document.getElementById('estoqueBaixarMateriaisGroup');

            if (tipo === 'material') {
                // Esconde a pergunta de baixar materiais quando n√£o for muni√ß√£o
                if (baixarGroup) {
                    baixarGroup.style.display = 'none';
                }
                estoque.materiais.forEach(material => {
                    const option = document.createElement('option');
                    option.value = material.nome;
                    option.textContent = material.nome;
                    itemSelect.appendChild(option);
                });
            } else if (tipo === 'municao') {
                // Exibe a pergunta de baixar materiais quando o tipo for muni√ß√£o
                if (baixarGroup) {
                    baixarGroup.style.display = 'block';
                }
                estoque.municoes.forEach(municao => {
                    const option = document.createElement('option');
                    // Para muni√ß√µes, utilizamos o campo nome (ex.: 5mm, 9mm, 762mm, 12cbc)
                    option.value = municao.nome || municao.tipo;
                    option.textContent = formatMunicaoName(municao.nome || municao.tipo);
                    itemSelect.appendChild(option);
                });
            } else {
                // Se nenhum tipo selecionado, esconde a pergunta
                if (baixarGroup) {
                    baixarGroup.style.display = 'none';
                }
            }
        }

        // Sistema de Relat√≥rios
        function loadRelatorios() {
            loadMembrosRelatorio();
            updateRelatorioSummary();
            // Gera um relat√≥rio padr√£o (hoje, geral) assim que a aba for aberta para exibir dados imediatamente
            try {
                gerarRelatorio();
            } catch (e) {
                console.warn('Erro ao gerar relat√≥rio padr√£o:', e);
            }
        }

        function loadMembrosRelatorio() {
            const select = document.getElementById('membroFiltro');
            select.innerHTML = '<option value="">Todos os Membros</option>';
            
            membros.forEach(membro => {
                const option = document.createElement('option');
                option.value = membro.id;
                option.textContent = membro.nome;
                select.appendChild(option);
            });
        }

        function updateRelatorioOptions() {
            const tipo = document.getElementById('tipoRelatorio').value;
            const membroGroup = document.getElementById('membroFiltroGroup');
            const usuarioGroup = document.getElementById('usuarioFiltroGroup');
            // Por padr√£o, esconde ambos
            membroGroup.style.display = 'none';
            usuarioGroup.style.display = 'none';
            if (tipo === 'membros' || tipo === 'rotas') {
                membroGroup.style.display = 'block';
            } else if (tipo === 'usuarios') {
                usuarioGroup.style.display = 'block';
                // Carrega lista de usu√°rios para o filtro
                loadUsuariosRelatorio();
            }
        }

        function updateRelatorioSummary() {
            document.getElementById('totalMembrosRelatorio').textContent = membros.length;
            document.getElementById('totalRotasRelatorio').textContent = rotas.length;
            document.getElementById('totalEncomendasRelatorio').textContent = encomendas.length;

            const totalVendas = encomendas.reduce((sum, e) => sum + (parseFloat(e.valor_total) || 0), 0);
            const totalComissoes = encomendas.reduce((sum, e) => sum + (parseFloat(e.comissao) || 0), 0);

            document.getElementById('totalVendasRelatorio').textContent = `R$ ${totalVendas.toFixed(2)}`;
            document.getElementById('totalComissoesRelatorio').textContent = `R$ ${totalComissoes.toFixed(2)}`;
        }

        function gerarRelatorio() {
            const tipo = document.getElementById('tipoRelatorio').value;
            const periodo = document.getElementById('periodoRelatorio').value;
            const membroId = document.getElementById('membroFiltro').value;
            
            let dataInicio, dataFim;
            
            if (periodo === 'personalizado') {
                dataInicio = new Date(document.getElementById('dataInicio').value);
                dataFim = new Date(document.getElementById('dataFim').value);
            } else {
                const hoje = new Date();
                dataFim = new Date(hoje);
                
                switch(periodo) {
                    case 'hoje':
                        dataInicio = new Date(hoje);
                        break;
                    case 'semana':
                        dataInicio = new Date(hoje.setDate(hoje.getDate() - 7));
                        break;
                    case 'mes':
                        dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 1));
                        break;
                    case 'trimestre':
                        dataInicio = new Date(hoje.setMonth(hoje.getMonth() - 3));
                        break;
                    case 'ano':
                        dataInicio = new Date(hoje.setFullYear(hoje.getFullYear() - 1));
                        break;
                }
            }
            
            const dadosFiltrados = filtrarDadosPorPeriodo(tipo, dataInicio, dataFim, membroId);
            renderRelatorioDetalhes(dadosFiltrados, tipo);
            updateChartArea(dadosFiltrados, tipo);
        }

        function filtrarDadosPorPeriodo(tipo, dataInicio, dataFim, membroId) {
            let dados = [];
            
            switch(tipo) {
                case 'membros':
                    dados = membros.filter(m => {
                        const dataCadastro = new Date(m.data_criacao || m.data_cadastro);
                        const dentroPeriodo = dataCadastro >= dataInicio && dataCadastro <= dataFim;
                        const membroCorreto = !membroId || m.id == membroId;
                        return dentroPeriodo && membroCorreto;
                    }).map(m => ({
                        data: m.data_criacao || m.data_cadastro,
                        tipo: 'Membro',
                        descricao: `Cadastro: ${m.nome}`,
                        valor: '-',
                        status: 'Ativo'
                    }));
                    break;
                    
                case 'rotas':
                    dados = rotas.filter(r => {
                        const dataEntrega = new Date(r.data_entrega);
                        const dentroPeriodo = dataEntrega >= dataInicio && dataEntrega <= dataFim;
                        let membroCorreto = true;
                        if (membroId) {
                            // Se houver membroId, filtra por id ou por nome
                            membroCorreto = (r.membro_id && r.membro_id == membroId) || (r.membro_nome && r.membro_nome == getMembroNomeById(membroId));
                        }
                        return dentroPeriodo && membroCorreto;
                    }).map(r => ({
                        data: r.data_entrega,
                        tipo: 'Rota',
                        descricao: `${r.membro_nome} - Qtd: ${r.quantidade}`,
                        valor: '-',
                        status: r.status
                    }));
                    break;
                    
                case 'encomendas':
                    dados = encomendas.filter(e => {
                        const dataEncomenda = new Date(e.data_criacao || new Date());
                        return dataEncomenda >= dataInicio && dataEncomenda <= dataFim;
                    }).map(e => ({
                        data: e.data_criacao || new Date().toISOString(),
                        tipo: 'Encomenda',
                        descricao: `Cliente: ${e.cliente}`,
                        valor: `R$ ${e.valor_total.toFixed(2)}`,
                        status: e.status
                    }));
                    break;
                    
                case 'usuarios':
                    // Gera relat√≥rio de desempenho por usu√°rio (vendedor e entregador). Aggrega encomendas e rotas por usu√°rio
                    const usuarioFiltro = document.getElementById('usuarioFiltro') ? document.getElementById('usuarioFiltro').value : '';
                    const mapaUsuarios = {};
                    // Agrupa encomendas por usu√°rio
                    encomendas.forEach(e => {
                        const dataEncomenda = new Date(e.data_criacao || new Date());
                        if (dataEncomenda < dataInicio || dataEncomenda > dataFim) return;
                        const user = e.usuario || 'Desconhecido';
                        // Se existir filtro, ignora outros
                        if (usuarioFiltro && usuarioFiltro !== user) return;
                        if (!mapaUsuarios[user]) {
                            mapaUsuarios[user] = { encomendasCount: 0, valorTotal: 0, comissoes: 0, rotasCount: 0 };
                        }
                        mapaUsuarios[user].encomendasCount += 1;
                        mapaUsuarios[user].valorTotal += parseFloat(e.valor_total) || 0;
                        mapaUsuarios[user].comissoes += parseFloat(e.comissao) || 0;
                    });
                    // Agrupa rotas entregues por usu√°rio
                    rotas.forEach(r => {
                        const dataRota = new Date(r.data_entrega);
                        if (dataRota < dataInicio || dataRota > dataFim) return;
                        if (r.status !== 'entregue') return;
                        const user = r.membro_nome || 'Desconhecido';
                        if (usuarioFiltro && usuarioFiltro !== user) return;
                        if (!mapaUsuarios[user]) {
                            mapaUsuarios[user] = { encomendasCount: 0, valorTotal: 0, comissoes: 0, rotasCount: 0 };
                        }
                        // Considera cada rota como 1 entrega
                        mapaUsuarios[user].rotasCount += 1;
                    });
                    dados = Object.keys(mapaUsuarios).map(u => {
                        const info = mapaUsuarios[u];
                        return {
                            data: new Date().toISOString(),
                            tipo: 'Usu√°rio',
                            descricao: `${u} - Encs: ${info.encomendasCount}, Rotas: ${info.rotasCount}`,
                            valor: `R$ ${info.valorTotal.toFixed(2)}`,
                            status: `Comiss√µes: R$ ${info.comissoes.toFixed(2)}`
                        };
                    });
                    break;
                case 'financeiro':
                    dados = encomendas.filter(e => {
                        const dataEncomenda = new Date(e.data_criacao || new Date());
                        return dataEncomenda >= dataInicio && dataEncomenda <= dataFim;
                    }).map(e => ({
                        data: e.data_criacao || new Date().toISOString(),
                        tipo: 'Venda',
                        descricao: `${e.cliente} - Comiss√£o: R$ ${e.comissao.toFixed(2)}`,
                        valor: `R$ ${e.valor_total.toFixed(2)}`,
                        status: e.status
                    }));
                    break;

                case 'estoque':
                    // Relat√≥rio de estoque: lista todos os itens do estoque com suas quantidades
                    dados = [];
                    if (estoque && Array.isArray(estoque.materiais)) {
                        estoque.materiais.forEach(item => {
                            dados.push({
                                data: new Date().toISOString(),
                                tipo: 'Estoque',
                                descricao: `${item.tipo}: ${item.nome}`,
                                valor: `${item.quantidade}`,
                                status: '-'
                            });
                        });
                    }
                    if (estoque && Array.isArray(estoque.municoes)) {
                        estoque.municoes.forEach(item => {
                            dados.push({
                                data: new Date().toISOString(),
                                tipo: 'Estoque',
                                descricao: `${item.tipo}: ${formatMunicaoName(item.nome || item.tipo)}`,
                                valor: `${item.quantidade}`,
                                status: '-'
                            });
                        });
                    }
                    break;
                    
                default:
                    // Relat√≥rio geral - combina todos os dados
                    dados = [
                        ...membros.map(m => ({
                            data: m.data_cadastro,
                            tipo: 'Membro',
                            descricao: `Cadastro: ${m.nome}`,
                            valor: '-',
                            status: 'Ativo'
                        })),
                        ...rotas.map(r => ({
                            data: r.data_entrega,
                            tipo: 'Rota',
                            descricao: `${r.membro_nome} - Qtd: ${r.quantidade}`,
                            valor: '-',
                            status: r.status
                        })),
                        ...encomendas.map(e => ({
                            data: e.data_criacao || new Date().toISOString(),
                            tipo: 'Encomenda',
                            descricao: `Cliente: ${e.cliente}`,
                            valor: `R$ ${e.valor_total.toFixed(2)}`,
                            status: e.status
                        }))
                    ].filter(item => {
                        const dataItem = new Date(item.data);
                        return dataItem >= dataInicio && dataItem <= dataFim;
                    });
            }
            
            return dados.sort((a, b) => new Date(b.data) - new Date(a.data));
        }

        function renderRelatorioDetalhes(dados, tipo) {
            const tbody = document.getElementById('relatorioTableBody');
            tbody.innerHTML = '';
            
            if (dados.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" style="text-align: center; color: #95a5a6; padding: 40px;">
                            Nenhum dado encontrado para o per√≠odo selecionado
                        </td>
                    </tr>
                `;
                return;
            }
            
            dados.forEach(item => {
                const row = document.createElement('tr');
                row.innerHTML = `
                    <td>${new Date(item.data).toLocaleDateString('pt-BR')}</td>
                    <td>${item.tipo}</td>
                    <td>${item.descricao}</td>
                    <td>${item.valor}</td>
                    <td><span style="color: ${getStatusColor(item.status)}">${item.status}</span></td>
                `;
                tbody.appendChild(row);
            });
        }

        // ==================== Gest√£o de Fam√≠lias ====================
        /**
         * Carrega as fam√≠lias cadastradas do backend e popula o select de fam√≠lia.
         * Adiciona a op√ß√£o "Outro" ao final para permitir cadastro manual.
         */
        async function loadFamilias() {
            try {
                const response = await fetch(`${API_BASE}/familias`);
                const data = await response.json();
                const select = document.getElementById('encomendaFamiliaSelect');
                if (select) {
                    // Reinicia op√ß√µes padr√£o
                    select.innerHTML = '<option value="">Selecione uma fam√≠lia...</option>';
                    if (Array.isArray(data)) {
                        data.forEach(f => {
                            const option = document.createElement('option');
                            option.value = f.nome;
                            option.textContent = f.nome;
                            select.appendChild(option);
                        });
                    }

        /**
         * Carrega os membros ativos do backend e popula o seletor de usu√°rio respons√°vel pela encomenda.
         * Somente nomes de membros s√£o utilizados no campo "Vendedor" da encomenda.
         */
        async function loadEncomendaMembros() {
            try {
                const response = await fetch(`${API_BASE}/membros`);
                const data = await response.json();
                const select = document.getElementById('encomendaUsuarioSelect');
                if (select) {
                    select.innerHTML = '';
                    if (Array.isArray(data)) {
                        data.forEach(m => {
                            const option = document.createElement('option');
                            option.value = m.nome;
                            option.textContent = m.nome;
                            select.appendChild(option);
                        });
                    }
                }
            } catch (error) {
                console.error('Erro ao carregar membros para encomenda:', error);
            }
        }
                    // Adiciona op√ß√£o "Outro" para cadastro manual
                    const outroOption = document.createElement('option');
                    outroOption.value = 'outro';
                    outroOption.textContent = 'Outro...';
                    select.appendChild(outroOption);
                }
            } catch (error) {
                console.error('Erro ao carregar fam√≠lias:', error);
            }
        }

        /**
         * Controla a exibi√ß√£o do campo de texto para nova fam√≠lia quando o usu√°rio
         * seleciona a op√ß√£o "Outro" no select.
         */
        function handleFamiliaSelectChange() {
            const select = document.getElementById('encomendaFamiliaSelect');
            const outroInput = document.getElementById('encomendaFamiliaOutro');
            if (!select || !outroInput) return;
            if (select.value === 'outro') {
                outroInput.style.display = 'block';
                outroInput.required = true;
            } else {
                outroInput.style.display = 'none';
                outroInput.required = false;
                outroInput.value = '';
            }
        }

        function getStatusColor(status) {
            switch(status.toLowerCase()) {
                case 'ativo':
                case 'entregue':
                case 'pronto':
                    return '#2ecc71';
                case 'pendente':
                case 'produzindo':
                    return '#f39c12';
                default:
                    return '#95a5a6';
            }
        }

        // Auxiliar: retorna o nome do membro pelo ID. Utilizado nos relat√≥rios para comparar rotas com filtro de membro.
        function getMembroNomeById(id) {
            const m = membros.find(mem => mem.id == id);
            return m ? m.nome : '';
        }

        function updateChartArea(dados, tipo) {
            const chartArea = document.getElementById('chartArea');
            
            if (dados.length === 0) {
                chartArea.innerHTML = 'Nenhum dado encontrado para o per√≠odo selecionado';
                return;
            }
            
            // Simular um gr√°fico simples com texto
            const tipoCount = {};
            dados.forEach(item => {
                tipoCount[item.tipo] = (tipoCount[item.tipo] || 0) + 1;
            });
            
            let chartHTML = '<div style="text-align: left;">';
            chartHTML += '<h5 style="color: #ecf0f1; margin-bottom: 15px;">Distribui√ß√£o por Tipo:</h5>';
            
            Object.entries(tipoCount).forEach(([tipo, count]) => {
                const percentage = ((count / dados.length) * 100).toFixed(1);
                chartHTML += `
                    <div style="margin-bottom: 10px;">
                        <span style="color: #bdc3c7;">${tipo}: ${count} (${percentage}%)</span>
                        <div style="background: rgba(52, 73, 94, 0.5); height: 8px; border-radius: 4px; margin-top: 5px;">
                            <div style="background: #8e44ad; height: 100%; width: ${percentage}%; border-radius: 4px;"></div>
                        </div>
                    </div>
                `;
            });
            
            chartHTML += '</div>';
            chartArea.innerHTML = chartHTML;
        }

        function exportarRelatorio() {
            alert('Funcionalidade de exporta√ß√£o em desenvolvimento. Em breve voc√™ poder√° exportar relat√≥rios em PDF.');
        }

        // Helper para formatar o nome de muni√ß√£o exibindo 762 sem "mm"
        function formatMunicaoName(name) {
            return name === '762mm' ? '762' : name;
        }

        /**
         * Carrega o invent√°rio completo do estoque e preenche a tabela do modal de invent√°rio.
         * Agrupa tanto materiais quanto muni√ß√µes em uma √∫nica listagem, indicando o tipo, nome
         * e quantidade. Esta fun√ß√£o √© executada quando o modal de invent√°rio √© aberto.
         */
        async function loadInventario() {
            try {
                const response = await fetch(`${API_BASE}/estoque`);
                const data = await response.json();
                const tbody = document.getElementById('inventarioTableBody');
                if (!tbody) return;
                let html = '';
                if (Array.isArray(data)) {
                    data.forEach(item => {
                        // Se o usu√°rio logado for admin, gerente ou l√≠der, permite edi√ß√£o do estoque
                        let editable = false;
                        try {
                            if (currentUser && ['admin','gerente','lider'].includes(currentUser.role)) {
                                editable = true;
                            }
                        } catch (e) {}
                        if (editable) {
                            html += `<tr>
                                <td>${item.tipo}</td>
                                <td>${item.nome}</td>
                                <td>
                                    <input type="number" id="inventario_qtd_${item.id}" value="${item.quantidade}" min="0" style="width:80px; padding:4px; margin-right:5px;">
                                    <button class="btn-primary" style="padding:4px 8px; font-size:12px;" onclick="salvarInventarioItem(${item.id})">Salvar</button>
                                </td>
                            </tr>`;
                        } else {
                            html += `<tr><td>${item.tipo}</td><td>${item.nome}</td><td>${item.quantidade}</td></tr>`;
                        }
                    });
                }
                tbody.innerHTML = html || '<tr><td colspan="3" style="text-align:center; color:#95a5a6; padding:20px;">Nenhum item encontrado</td></tr>';
            } catch (error) {
                console.error('Erro ao carregar invent√°rio:', error);
            }
        }

        /**
         * Salva a nova quantidade de um item de estoque. Envia requisi√ß√£o PUT para a API
         * /api/estoque/:id com a nova quantidade. Ap√≥s salvar, recarrega o estoque e
         * o invent√°rio, atualiza as estat√≠sticas e executa a verifica√ß√£o autom√°tica de
         * encomendas prontas. Apenas usu√°rios com permiss√£o (admin, gerente ou l√≠der)
         * conseguir√£o editar e salvar.
         */
        async function salvarInventarioItem(id) {
            const input = document.getElementById('inventario_qtd_' + id);
            if (!input) return;
            const qtd = parseFloat(input.value);
            if (isNaN(qtd) || qtd < 0) {
                alert('Quantidade inv√°lida');
                return;
            }
            try {
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/estoque/${id}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? `Bearer ${token}` : ''
                    },
                    body: JSON.stringify({ quantidade: qtd })
                });
                const data = await response.json();
                if (response.ok) {
                    alert(data.message || 'Item atualizado');
                    // Recarrega estoque e invent√°rio
                    await loadEstoque();
                    await loadInventario();
                    // Atualiza encomendas prontas e dashboard
                    try {
                        if (token) {
                            await fetch(`${API_BASE}/encomendas/atualizar-prontos`, { method: 'POST', headers: { 'Authorization': `Bearer ${token}` } });
                        }
                    } catch (err) {
                        console.error('Erro ao atualizar encomendas prontas:', err);
                    }
                    updateDashboardStats();
                } else {
                    alert(data.error || 'Erro ao atualizar estoque');
                }
            } catch (error) {
                console.error('Erro ao salvar invent√°rio:', error);
                alert('Erro ao salvar invent√°rio: ' + error.message);
            }
        }

        // Atualiza lista de itens na retirada de estoque conforme o tipo selecionado
        function updateRetiradaItemOptions() {
            const tipo = document.getElementById('retiradaTipo').value;
            const itemSelect = document.getElementById('retiradaItem');
            itemSelect.innerHTML = '<option value="">Selecione...</option>';
            if (!estoque || !estoque.materiais || !estoque.municoes) return;
            if (tipo === 'material') {
                estoque.materiais.forEach(mat => {
                    const option = document.createElement('option');
                    option.value = mat.nome;
                    option.textContent = mat.nome;
                    itemSelect.appendChild(option);
                });
            } else if (tipo === 'municao') {
                estoque.municoes.forEach(municao => {
                    const option = document.createElement('option');
                    option.value = municao.nome || municao.tipo;
                    option.textContent = formatMunicaoName(municao.nome || municao.tipo);
                    itemSelect.appendChild(option);
                });
            }
        }

        // Atualiza lista de itens na sa√≠da avulsa conforme o tipo selecionado
        function updateSaidaItemOptions() {
            const tipo = document.getElementById('saidaAvulsaTipo').value;
            const itemSelect = document.getElementById('saidaAvulsaItem');
            itemSelect.innerHTML = '<option value="">Selecione...</option>';
            if (!estoque || !estoque.materiais || !estoque.municoes) return;
            if (tipo === 'material') {
                estoque.materiais.forEach(mat => {
                    const option = document.createElement('option');
                    option.value = mat.nome;
                    option.textContent = mat.nome;
                    itemSelect.appendChild(option);
                });
            } else if (tipo === 'municao') {
                estoque.municoes.forEach(municao => {
                    const option = document.createElement('option');
                    option.value = municao.nome || municao.tipo;
                    option.textContent = formatMunicaoName(municao.nome || municao.tipo);
                    itemSelect.appendChild(option);
                });
            }
        }

        // Preenche o select de destinos com os nomes dos membros
        function populateSaidaDestinos() {
            const select = document.getElementById('saidaAvulsaDestinos');
            if (!select) return;
            select.innerHTML = '';
            if (!membros) return;
            membros.forEach(mem => {
                const option = document.createElement('option');
                option.value = mem.nome;
                option.textContent = mem.nome;
                select.appendChild(option);
            });
        }

        /**
         * Carrega a lista de usu√°rios (id, username) para o filtro de relat√≥rios
         * de desempenho por usu√°rio. Essa fun√ß√£o √© chamada quando o tipo de relat√≥rio
         * √© "usuarios" e o select correspondente √© exibido.
         */
        async function loadUsuariosRelatorio() {
            try {
                const select = document.getElementById('usuarioFiltro');
                if (!select) return;
                // Reset options
                select.innerHTML = '<option value="">Todos os Usu√°rios</option>';
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/usuarios`, {
                    headers: {
                        'Authorization': token ? `Bearer ${token}` : ''
                    }
                });
                const data = await response.json();
                if (Array.isArray(data)) {
                    data.forEach(u => {
                        const option = document.createElement('option');
                        option.value = u.username;
                        option.textContent = u.username;
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios para relat√≥rio:', error);
            }
        }

        // Carregar Imagens
        async function loadImagens() {
            document.getElementById('imagensLoading').style.display = 'block';
            document.getElementById('imagensTable').style.display = 'none';
            
            setTimeout(() => {
                document.getElementById('imagensLoading').style.display = 'none';
                document.getElementById('imagensTable').style.display = 'block';
                document.getElementById('imagensTableBody').innerHTML = '<tr><td colspan="5" style="text-align: center; color: #95a5a6; padding: 40px;">Nenhuma imagem encontrada</td></tr>';
            }, 1000);
        }

        // Event Listeners para Forms
        document.getElementById('membroForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const nome = document.getElementById('membroNome').value;
            const rg = document.getElementById('membroRG').value;
            const telefone = document.getElementById('membroTelefone').value;
            const cargo = document.getElementById('membroCargo').value;
            
            try {
                const response = await fetch(`${API_BASE}/membros`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ nome, rg, telefone, cargo })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert('Membro cadastrado com sucesso!');
                    closeModal('membroModal');
                    loadMembros();
                    this.reset();
                } else {
                    alert(data.error || 'Erro ao cadastrar membro');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        });

        document.getElementById('rotaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Obtem o nome do membro selecionado em vez do ID.  
            // O backend espera receber o campo membro_nome.
            const membroSelect = document.getElementById('rotaMembro');
            const membro_nome = membroSelect.options[membroSelect.selectedIndex].text;
            const quantidade = document.getElementById('rotaQuantidade').value;
            const data_entrega = document.getElementById('rotaData').value;
            const status = document.getElementById('rotaStatus').value;
            const fileInput = document.getElementById('rotaComprovante');
            const file = fileInput && fileInput.files && fileInput.files[0];
            const sendRequest = async (comprovanteBase64) => {
                try {
                    const payload = { membro_nome, quantidade, data_entrega, status };
                    if (comprovanteBase64) {
                        payload.comprovante = comprovanteBase64;
                    }
                    const response = await fetch(`${API_BASE}/rotas`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(payload)
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Rota cadastrada com sucesso!');
                        closeModal('rotaModal');
                        loadRotas();
                        this.reset();
                    } else {
                        alert(data.error || 'Erro ao cadastrar rota');
                    }
                } catch (error) {
                    alert('Erro de conex√£o: ' + error.message);
                }
            };
            // Se houver arquivo, l√™ como DataURL e envia. Caso contr√°rio, envia imediatamente.
            if (file) {
                const reader = new FileReader();
                reader.onload = function(evt) {
                    const base64 = evt.target.result;
                    sendRequest(base64);
                };
                reader.onerror = function() {
                    // Em caso de erro ao ler, envia sem imagem
                    sendRequest(null);
                };
                reader.readAsDataURL(file);
            } else {
                sendRequest(null);
            }
        });

        document.getElementById('encomendaForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            // Determina a fam√≠lia selecionada ou digitada
            let familiaValue = '';
            const familiaSelect = document.getElementById('encomendaFamiliaSelect');
            if (familiaSelect) {
                const selected = familiaSelect.value;
                if (selected === 'outro') {
                    familiaValue = document.getElementById('encomendaFamiliaOutro').value;
                } else {
                    familiaValue = selected;
                }
            }

            const formData = {
                cliente: document.getElementById('encomendaCliente').value,
                familia: familiaValue,
                // Telefone do cliente, pode ser vazio
                telefone_cliente: (function() {
                    const telInput = document.getElementById('encomendaClienteTelefone');
                    return telInput ? telInput.value : '';
                })(),
                municao_5mm: document.getElementById('municao5mm').value,
                preco_5mm: document.getElementById('preco5mm').value,
                municao_9mm: document.getElementById('municao9mm').value,
                preco_9mm: document.getElementById('preco9mm').value,
                municao_762mm: document.getElementById('municao762mm').value,
                preco_762mm: document.getElementById('preco762mm').value,
                municao_12cbc: document.getElementById('municao12cbc').value,
                preco_12cbc: document.getElementById('preco12cbc').value,
                status: document.getElementById('encomendaStatus').value,
                usuario: (function() {
                    const selUser = document.getElementById('encomendaUsuarioSelect');
                    return selUser ? selUser.value : null;
                })()
            };
            // Calcular valor total e comiss√£o antes de enviar para o servidor.  
            // O sistema original do Flask calcula esses valores automaticamente,
            // por isso replicamos aqui a l√≥gica: total = quantidade * pre√ßo e comiss√£o = 7% do total.
            const qtd5mm = parseInt(document.getElementById('municao5mm').value) || 0;
            const preco5mm = parseFloat(document.getElementById('preco5mm').value) || 0;
            const qtd9mm = parseInt(document.getElementById('municao9mm').value) || 0;
            const preco9mm = parseFloat(document.getElementById('preco9mm').value) || 0;
            const qtd762mm = parseInt(document.getElementById('municao762mm').value) || 0;
            const preco762mm = parseFloat(document.getElementById('preco762mm').value) || 0;
            const qtd12cbc = parseInt(document.getElementById('municao12cbc').value) || 0;
            const preco12cbc = parseFloat(document.getElementById('preco12cbc').value) || 0;
            const totalCalc = (qtd5mm * preco5mm) + (qtd9mm * preco9mm) + (qtd762mm * preco762mm) + (qtd12cbc * preco12cbc);
            const comissaoCalc = totalCalc * 0.07;
            formData.valor_total = parseFloat(totalCalc.toFixed(2));
            formData.comissao = parseFloat(comissaoCalc.toFixed(2));
            
            try {
                // Determina se estamos editando uma encomenda existente ou criando uma nova
                const isEditing = editingEncomendaId !== null;
                const url = isEditing ? `${API_BASE}/encomendas/${editingEncomendaId}` : `${API_BASE}/encomendas`;
                const method = isEditing ? 'PUT' : 'POST';
                const token = localStorage.getItem('authToken');
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? 'Bearer ' + token : undefined
                    },
                    body: JSON.stringify(formData)
                });
                const data = await response.json();
                if (response.ok) {
                    if (isEditing) {
                        alert('Encomenda atualizada com sucesso!');
                    } else {
                        alert('Encomenda cadastrada com sucesso!');
                    }
                    closeModal('encomendaModal');
                    // Limpa o estado de edi√ß√£o
                    editingEncomendaId = null;
                    // Atualiza lista de encomendas
                    loadEncomendas();
                    this.reset();
                    // Quando a fam√≠lia selecionada era "outro", garantir que o campo de texto seja escondido ao resetar
                    const outroInput = document.getElementById('encomendaFamiliaOutro');
                    if (outroInput) {
                        outroInput.style.display = 'none';
                        outroInput.required = false;
                    }
                    calcularTotal();
                } else {
                    alert(data.error || 'Erro ao salvar encomenda');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        });

        document.getElementById('estoqueForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const tipo = document.getElementById('estoqueType').value;
            const item = document.getElementById('estoqueItem').value;
            const quantidade = document.getElementById('estoqueQuantidade').value;

            // Para muni√ß√µes, capturar a op√ß√£o de baixar materiais do estoque
            let baixarMateriais = null;
            if (tipo === 'municao') {
                const sel = document.getElementById('estoqueBaixarMateriais');
                baixarMateriais = sel ? sel.value : 'nao';
            }
            
            try {
                // Inclui o token de autentica√ß√£o para rotas protegidas
                const token = localStorage.getItem('authToken');
                const response = await fetch(`${API_BASE}/estoque`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': token ? 'Bearer ' + token : undefined
                    },
                    body: JSON.stringify({ tipo, item, quantidade, baixarMateriais })
                });
                
                const data = await response.json();
                
                if (response.ok) {
                    alert(data.message || 'Estoque atualizado com sucesso!');
                    closeModal('estoqueModal');
                    // Ap√≥s atualizar o estoque, aciona a atualiza√ß√£o de encomendas prontas com base no estoque
                    try {
                        const tokenHeader = token ? { 'Authorization': 'Bearer ' + token } : {};
                        await fetch(`${API_BASE}/encomendas/atualizar-prontos`, {
                            method: 'POST',
                            headers: tokenHeader
                        });
                        // Recarrega encomendas e dashboard para refletir altera√ß√µes
                        loadEncomendas();
                        updateDashboardStats();
                    } catch (e) {
                        console.error('Erro ao atualizar encomendas ap√≥s ajuste de estoque', e);
                    }
                    loadEstoque();
                    this.reset();
                    // Esconder campo de baixar materiais novamente
                    const g = document.getElementById('estoqueBaixarMateriaisGroup');
                    if (g) g.style.display = 'none';
                } else {
                    alert(data.error || 'Erro ao atualizar estoque');
                }
            } catch (error) {
                alert('Erro de conex√£o: ' + error.message);
            }
        });

        // Evento de cadastro de novas fam√≠lias (dispon√≠vel apenas para gerentes/admin)
        const familiaFormEl = document.getElementById('familiaForm');
        if (familiaFormEl) {
            familiaFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();
                const nome = document.getElementById('familiaNome').value;
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_BASE}/familias`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': 'Bearer ' + token
                        },
                        body: JSON.stringify({ nome })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert('Fam√≠lia cadastrada com sucesso!');
                        closeModal('familiaModal');
                        // Recarrega fam√≠lias para refletir a nova fam√≠lia na lista
                        loadFamilias();
                        this.reset();
                    } else {
                        alert(data.error || 'Erro ao cadastrar fam√≠lia');
                    }
                } catch (error) {
                    alert('Erro de conex√£o: ' + error.message);
                }
            });
        }

        // Evento de retirada de estoque (corre√ß√£o)
        const retiradaFormEl = document.getElementById('retiradaForm');
        if (retiradaFormEl) {
            retiradaFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();
                const tipo = document.getElementById('retiradaTipo').value;
                const item = document.getElementById('retiradaItem').value;
                const quantidade = document.getElementById('retiradaQuantidade').value;
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_BASE}/estoque/retirar`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? 'Bearer ' + token : undefined
                        },
                        body: JSON.stringify({ tipo, item, quantidade })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert(data.message || 'Retirada realizada com sucesso!');
                        closeModal('retiradaModal');
                        loadEstoque();
                        this.reset();
                    } else {
                        alert(data.error || 'Erro ao realizar retirada');
                    }
                } catch (error) {
                    alert('Erro de conex√£o: ' + error.message);
                }
            });
        }

        // Evento de sa√≠da avulsa (destinar estoque a membros)
        const saidaFormEl = document.getElementById('saidaAvulsaForm');
        if (saidaFormEl) {
            saidaFormEl.addEventListener('submit', async function(e) {
                e.preventDefault();
                const tipo = document.getElementById('saidaAvulsaTipo').value;
                const item = document.getElementById('saidaAvulsaItem').value;
                const quantidade = document.getElementById('saidaAvulsaQuantidade').value;
                const destinosSelect = document.getElementById('saidaAvulsaDestinos');
                const selectedDestinos = Array.from(destinosSelect.selectedOptions).map(opt => opt.value);
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_BASE}/estoque/saida-avulsa`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? 'Bearer ' + token : undefined
                        },
                        body: JSON.stringify({ tipo, item, quantidade, destinos: selectedDestinos })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert(data.message || 'Sa√≠da avulsa registrada com sucesso!');
                        closeModal('saidaAvulsaModal');
                        loadEstoque();
                        this.reset();
                    } else {
                        alert(data.error || 'Erro ao registrar sa√≠da avulsa');
                    }
                } catch (error) {
                    alert('Erro de conex√£o: ' + error.message);
                }
            });
        }

        function fabricarMunicao() {
            const tipo = document.getElementById('tipoMunicao').value;
            const lotes = document.getElementById('quantidadeLotes').value;
            
            if (!tipo || !lotes) {
                alert('Selecione o tipo de muni√ß√£o e quantidade de lotes');
                return;
            }
            
            const quantidade = lotes * 200;
            alert(`Fabrica√ß√£o iniciada: ${quantidade} muni√ß√µes ${tipo} (${lotes} lotes)`);
        }

        /**
         * Carrega os usu√°rios com papel de l√≠der e popula o seletor do modal de pagamento.
         * Utiliza o endpoint /api/usuarios para obter a lista de usu√°rios e filtra por role = 'lider'.
         */
        async function loadLideres() {
            const select = document.getElementById('pagamentoLiderSelect');
            if (!select) return;
            // Limpa op√ß√µes existentes
            select.innerHTML = '<option value="">Selecione...</option>';
            try {
            // Busca usu√°rios e membros para associar o nome do membro ao usu√°rio l√≠der.
            const [usersRes, membrosRes] = await Promise.all([
                fetch(`${API_BASE}/usuarios`),
                fetch(`${API_BASE}/membros`)
            ]);
            const usuarios = await usersRes.json();
            const membros = await membrosRes.json();
            // Filtra somente os usu√°rios com papel de l√≠der
            const lideres = Array.isArray(usuarios) ? usuarios.filter(u => u.role === 'lider') : [];
            lideres.forEach(u => {
                const opt = document.createElement('option');
                opt.value = u.id;
                // Tenta encontrar o nome do membro associado a este usu√°rio (campo usuario_id)
                let displayName = u.username;
                if (Array.isArray(membros)) {
                    const membro = membros.find(m => m.usuario_id === u.id);
                    if (membro && membro.nome) {
                        displayName = membro.nome;
                    }
                }
                opt.textContent = displayName;
                select.appendChild(opt);
            });
            } catch (err) {
                console.error('Erro ao carregar l√≠deres:', err);
            }
        }

        /**
         * Abre o modal de pagamento para a rota especificada.  Antes de abrir, popula
         * o seletor de l√≠deres e armazena o id da rota para uso no envio.
         * @param {number} rotaId
         */
        function openPagamentoModal(rotaId) {
            const idInput = document.getElementById('pagamentoRotaId');
            if (idInput) {
                idInput.value = rotaId;
            }
            // Carrega l√≠deres e abre o modal
            loadLideres().then(() => {
                openModal('pagamentoModal');
            });
        }

        // Envia a solicita√ß√£o de pagamento ao backend ao submeter o formul√°rio de pagamento.
        const pagamentoForm = document.getElementById('pagamentoForm');
        if (pagamentoForm) {
            pagamentoForm.addEventListener('submit', async function(event) {
                event.preventDefault();
                const rotaId = document.getElementById('pagamentoRotaId').value;
                const liderId = document.getElementById('pagamentoLiderSelect').value;
                if (!liderId) {
                    alert('Selecione um l√≠der respons√°vel');
                    return;
                }
                if (!confirm('Deseja realmente lan√ßar o pagamento desta rota?')) {
                    return;
                }
                try {
                    const token = localStorage.getItem('authToken');
                    const response = await fetch(`${API_BASE}/rotas/${rotaId}/pagamento`, {
                        method: 'PUT',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': token ? 'Bearer ' + token : undefined
                        },
                        body: JSON.stringify({ pagante_id: liderId })
                    });
                    const data = await response.json();
                    if (response.ok) {
                        alert(data.message || 'Pagamento lan√ßado com sucesso!');
                        closeModal('pagamentoModal');
                        loadRotas();
                    } else {
                        alert(data.error || 'Erro ao lan√ßar pagamento');
                    }
                } catch (error) {
                    alert('Erro de conex√£o: ' + error.message);
                }
            });
        }

        function logout() {
            localStorage.removeItem('authToken');
            localStorage.removeItem('user');
            window.location.href = '/static/login_simple.html';
        }

        // Fechar modal ao clicar fora
        window.onclick = function(event) {
            if (event.target.classList.contains('modal')) {
                event.target.style.display = 'none';
            }
        }

        // ====================== Invent√°rio Fam√≠lia ========================
        let inventarioFamilia = [];
        let requisicoesFamilia = [];

        /**
         * Carrega o invent√°rio da fam√≠lia e as requisi√ß√µes associadas. Esta
         * fun√ß√£o √© chamada quando a aba de invent√°rio fam√≠lia √© aberta.
         */
        async function loadInventarioFamilia() {
            const inventarioLoading = document.getElementById('inventarioFamiliaLoading');
            const inventarioContent = document.getElementById('inventarioFamiliaContent');
            inventarioLoading.style.display = 'block';
            inventarioContent.style.display = 'none';
            try {
                // Carrega invent√°rio
                const invRes = await fetch(`${API_BASE}/inventario-familia`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const invData = await invRes.json();
                if (!invRes.ok) throw new Error(invData.error || 'Erro ao carregar invent√°rio');
                inventarioFamilia = invData;
                // Carrega requisi√ß√µes
                const reqRes = await fetch(`${API_BASE}/requisicoes-familia`, {
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const reqData = await reqRes.json();
                if (!reqRes.ok) throw new Error(reqData.error || 'Erro ao carregar requisi√ß√µes');
                requisicoesFamilia = reqData;
                renderInventarioFamiliaTable();
                renderRequisicoesFamiliaTable();
                updateInventarioFamiliaActions();
                inventarioLoading.style.display = 'none';
                inventarioContent.style.display = 'block';
            } catch (error) {
                inventarioLoading.textContent = `Erro: ${error.message}`;
            }
        }

        /**
         * Atualiza as a√ß√µes dispon√≠veis no invent√°rio da fam√≠lia baseado no papel
         * do usu√°rio. Administradores e l√≠deres podem adicionar itens.
         */
        function updateInventarioFamiliaActions() {
            const user = currentUser || JSON.parse(localStorage.getItem('user') || '{}');
            const actionsDiv = document.getElementById('inventarioFamiliaActions');
            if (!actionsDiv) return;
            actionsDiv.innerHTML = '';
            
            // A√ß√£o para adicionar item (somente l√≠deres/administradores)
            if (user.role === 'admin' || user.role === 'lider') {
                const addBtn = document.createElement('button');
                addBtn.className = 'btn-primary';
                addBtn.textContent = 'Adicionar Item';
                addBtn.onclick = () => {
                    openAddItemFamilia();
                };
                actionsDiv.appendChild(addBtn);
            }
        }

        /**
         * Mapeia nomes de itens para arquivos de imagem
         */
        function getItemImagePath(itemName) {
            const imageMap = {
                // Acess√≥rios
                'Clipe extendido': 'clipextendido.jpg',
                'Compensador': 'compensador.jpg',
                'Grip avan√ßado': 'grip.jpg',
                'Lanterna': 'lanterna.jpg',
                'Supressor': 'supressor.jpg',
                'Mira': 'mira.jpg',
                
                // Equipamentos
                'Adrenalina': 'adrenalina.jpg',
                'Algema': 'algema.jpg',
                'Camisa de For√ßa': 'camisadeforca.jpg',
                'Capuz': 'capuz.jpg',
                'Colete': 'colete.jpg',
                'Pager': 'pager.jpg',
                'Placa': 'placa.jpg',
                'Rastreador': 'rastreador.jpg',
                'Vaselina': 'vaselina.jpg',
                
                // Produtos Comprados
                'Balinha': 'balinha.jpg',
                'Rap√©': 'rape.jpg',
                'Farinha': 'farinha.jpg',
                'H.': 'h.jpg',
                'Lan√ßa': 'lan√ßa.jpg',
                'Oxy': 'oxy.jpg',
                'Viagra': 'viagra.jpg',
                
                // Armas - Nomes corrigidos conforme aparecem no sistema
                'AK 47': 'ak47.jpg',
                'AK 103': 'ak103.jpg',
                'AUG': 'aug.jpg',
                'M16': 'm16.jpg',
                'M1911': 'm1911.jpg',
                'MTAR': 'mtar.jpg',
                'M-tar 21': 'mtar21.jpg',
                'Mini Uzi': 'miniuzi.jpg',
                'SPAS 12': 'spas12.jpg',
                'TEC-9': 'tec9.jpg',
                'Colt 45': 'colt45.jpg',
                'Five-Seven': 'fiveseven.jpg',
                '.45 ACB': '45acb.jpg',
                'Katana': 'katana.jpg',
                
                // Ferramentas - Nomes corrigidos conforme aparecem no sistema
                'Flipper MK4': 'flippermk4.jpg',
                'Flipper MK5': 'flippermk5.jpg',
                'Masterpick': 'masterpick.jpg',
                'Chave Ouro': 'chavedeouro.jpg',
                'Chave Platina': 'chavedeplatina.jpg',
                'C4': 'c4.jpg'
            };
            
            // Busca exata primeiro
            if (imageMap[itemName]) {
                return `/static/images/items/${imageMap[itemName]}`;
            }
            
            // Busca parcial (caso o nome no banco seja ligeiramente diferente)
            for (const [key, value] of Object.entries(imageMap)) {
                if (itemName.toLowerCase().includes(key.toLowerCase()) || key.toLowerCase().includes(itemName.toLowerCase())) {
                    return `/static/images/items/${value}`;
                }
            }
            
            // Imagem padr√£o se n√£o encontrar
            return '/static/images/items/default.jpg';
        }

        /**
         * Renderiza o invent√°rio da fam√≠lia em formato de grid com categorias em linhas
         * e itens em colunas, mostrando quantidade, imagens e a√ß√µes para cada item.
         */
        function renderInventarioFamiliaTable() {
            const grid = document.getElementById('inventarioFamiliaGrid');
            if (!grid) return;
            grid.innerHTML = '';
            const user = currentUser || JSON.parse(localStorage.getItem('user') || '{}');
            
            // Agrupar por categoria
            const grouped = {};
            inventarioFamilia.forEach(item => {
                if (!grouped[item.categoria]) grouped[item.categoria] = [];
                grouped[item.categoria].push(item);
            });

            // Criar grid para cada categoria
            Object.keys(grouped).sort().forEach(categoria => {
                const categorySection = document.createElement('div');
                categorySection.style.cssText = 'margin-bottom: 25px; background: rgba(52, 73, 94, 0.3); border-radius: 8px; padding: 15px;';
                
                // T√≠tulo da categoria
                const categoryTitle = document.createElement('h5');
                categoryTitle.textContent = categoria;
                categoryTitle.style.cssText = 'color: #3498db; margin: 0 0 15px 0; font-size: 18px; font-weight: 600; border-bottom: 2px solid #3498db; padding-bottom: 5px;';
                categorySection.appendChild(categoryTitle);
                
                // Grid de itens
                const itemsGrid = document.createElement('div');
                itemsGrid.style.cssText = 'display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 15px;';
                
                grouped[categoria].forEach(item => {
                    const itemCard = document.createElement('div');
                    itemCard.style.cssText = 'background: rgba(44, 62, 80, 0.6); border-radius: 8px; padding: 15px; border: 1px solid rgba(236, 240, 241, 0.1); transition: all 0.3s ease; display: flex; flex-direction: column; height: 280px;';
                    itemCard.onmouseover = () => itemCard.style.background = 'rgba(44, 62, 80, 0.8)';
                    itemCard.onmouseout = () => itemCard.style.background = 'rgba(44, 62, 80, 0.6)';
                    
                    // Container da imagem
                    const imageContainer = document.createElement('div');
                    imageContainer.style.cssText = 'width: 100%; height: 120px; margin-bottom: 12px; display: flex; align-items: center; justify-content: center; background: rgba(0,0,0,0.2); border-radius: 6px; overflow: hidden;';
                    
                    const itemImage = document.createElement('img');
                    const imagePath = getItemImagePath(item.item);
                    itemImage.src = imagePath;
                    itemImage.alt = item.item;
                    itemImage.style.cssText = 'max-width: 100%; max-height: 100%; object-fit: contain; border-radius: 4px;';
                    itemImage.onerror = function() {
                        // Se a imagem n√£o carregar, mostra um √≠cone padr√£o
                        this.style.display = 'none';
                        const placeholder = document.createElement('div');
                        placeholder.style.cssText = 'width: 80px; height: 80px; background: rgba(52, 152, 219, 0.3); border-radius: 50%; display: flex; align-items: center; justify-content: center; color: #3498db; font-size: 24px;';
                        placeholder.textContent = 'üì¶';
                        imageContainer.appendChild(placeholder);
                    };
                    imageContainer.appendChild(itemImage);
                    itemCard.appendChild(imageContainer);
                    
                    // Nome do item
                    const itemName = document.createElement('div');
                    itemName.textContent = item.item;
                    itemName.style.cssText = 'color: #ecf0f1; font-weight: 600; margin-bottom: 8px; font-size: 14px; text-align: center; line-height: 1.3;';
                    itemCard.appendChild(itemName);
                    
                    // Quantidade
                    const itemQty = document.createElement('div');
                    itemQty.textContent = `Estoque: ${item.quantidade}`;
                    itemQty.style.cssText = `color: ${item.quantidade > 0 ? '#2ecc71' : '#e74c3c'}; font-weight: 600; margin-bottom: 8px; font-size: 13px; text-align: center;`;
                    itemCard.appendChild(itemQty);
                    
                    // Pre√ßo (se houver)
                    if (item.preco && item.preco > 0) {
                        const itemPrice = document.createElement('div');
                        itemPrice.textContent = `R$ ${item.preco.toFixed(2)}`;
                        itemPrice.style.cssText = 'color: #f39c12; font-size: 12px; margin-bottom: 8px; text-align: center; font-weight: 500;';
                        itemCard.appendChild(itemPrice);
                    }
                    
                    // Spacer para empurrar a√ß√µes para baixo
                    const spacer = document.createElement('div');
                    spacer.style.cssText = 'flex: 1;';
                    itemCard.appendChild(spacer);
                    
                    // A√ß√µes (apenas para admin e l√≠der)
                    if (user.role === 'admin' || user.role === 'lider') {
                        const actionsDiv = document.createElement('div');
                        actionsDiv.style.cssText = 'display: flex; gap: 5px; flex-wrap: wrap; margin-top: auto;';
                        
                        const addBtn = document.createElement('button');
                        addBtn.textContent = '+ Estoque';
                        addBtn.className = 'btn-primary';
                        addBtn.style.cssText = 'font-size: 11px; padding: 6px 12px; flex: 1; min-width: 70px; border-radius: 4px;';
                        addBtn.onclick = () => openAdicionarEstoque(item.id, item.categoria, item.item);
                        actionsDiv.appendChild(addBtn);
                        
                        itemCard.appendChild(actionsDiv);
                    }
                    
                    itemsGrid.appendChild(itemCard);
                });
                
                categorySection.appendChild(itemsGrid);
                grid.appendChild(categorySection);
            });
        }

        /**
         * Renderiza a tabela de requisi√ß√µes da fam√≠lia com layout profissional.
         * Exibe a√ß√µes contextuais dependendo do status da requisi√ß√£o e do papel do usu√°rio.
         */
        function renderRequisicoesFamiliaTable() {
            const body = document.getElementById('requisicoesFamiliaTableBody');
            const noRequisicoes = document.getElementById('noRequisicoes');
            if (!body) return;
            
            body.innerHTML = '';
            const user = currentUser || JSON.parse(localStorage.getItem('user') || '{}');
            
            // Se n√£o h√° requisi√ß√µes, mostra mensagem
            if (!requisicoesFamilia || requisicoesFamilia.length === 0) {
                if (noRequisicoes) noRequisicoes.style.display = 'block';
                return;
            }
            
            if (noRequisicoes) noRequisicoes.style.display = 'none';
            
            requisicoesFamilia.forEach((req, index) => {
                const tr = document.createElement('tr');
                tr.style.borderBottom = '1px solid rgba(255,255,255,0.1)';
                tr.style.transition = 'background-color 0.2s ease';
                
                // Hover effect
                tr.onmouseenter = () => tr.style.backgroundColor = 'rgba(255,255,255,0.05)';
                tr.onmouseleave = () => tr.style.backgroundColor = index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.04)';
                tr.style.backgroundColor = index % 2 === 0 ? 'rgba(255,255,255,0.02)' : 'rgba(255,255,255,0.04)';
                
                // Status com cores
                let statusBadge = '';
                switch(req.status) {
                    case 'pendente':
                        statusBadge = `<span style="background: #f39c12; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">‚è≥ Pendente</span>`;
                        break;
                    case 'aprovado':
                        statusBadge = `<span style="background: #27ae60; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">‚úÖ Aprovado</span>`;
                        break;
                    case 'entregue':
                        statusBadge = `<span style="background: #3498db; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">üì¶ Entregue</span>`;
                        break;
                    case 'rejeitado':
                        statusBadge = `<span style="background: #e74c3c; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">‚ùå Rejeitado</span>`;
                        break;
                    default:
                        statusBadge = `<span style="background: #95a5a6; color: white; padding: 4px 8px; border-radius: 12px; font-size: 0.85em; font-weight: 600;">${req.status}</span>`;
                }
                
                // Monta coluna de a√ß√µes
                let actionsHTML = '';
                if (user.role === 'admin' || user.role === 'lider') {
                    if (req.status === 'pendente') {
                        actionsHTML += `<button class="btn-primary" onclick="aprovarRequisicao(${req.id})" style="margin: 2px; padding: 6px 12px; font-size: 0.85em;">‚úÖ Aprovar</button>`;
                        actionsHTML += `<button class="btn-secondary" onclick="rejeitarRequisicao(${req.id})" style="margin: 2px; padding: 6px 12px; font-size: 0.85em;">‚ùå Rejeitar</button>`;
                    } else if (req.status === 'aprovado') {
                        actionsHTML += `<button class="btn-primary" onclick="entregarRequisicao(${req.id})" style="margin: 2px; padding: 6px 12px; font-size: 0.85em;">üì¶ Entregar</button>`;
                    } else if (req.status === 'entregue') {
                        actionsHTML += `<button class="btn-secondary" onclick="cancelarRequisicao(${req.id})" style="margin: 2px; padding: 6px 12px; font-size: 0.85em;">üîÑ Cancelar</button>`;
                    }
                }
                
                if (!actionsHTML) {
                    actionsHTML = '<span style="color: #95a5a6; font-style: italic;">Sem a√ß√µes</span>';
                }
                
                // Formatar data
                const dataFormatada = req.data_criacao ? new Date(req.data_criacao).toLocaleDateString('pt-BR') : '-';
                
                tr.innerHTML = `
                    <td style="padding: 12px; color: #ecf0f1;">
                        <div style="font-weight: 600;">${req.solicitante_nome || 'N/A'}</div>
                        <div style="font-size: 0.85em; color: #bdc3c7;">${req.solicitante_cargo || 'Membro'}</div>
                    </td>
                    <td style="padding: 12px; color: #ecf0f1;">
                        <div style="font-weight: 500;">${req.categoria || ''} - ${req.item || ''}</div>
                    </td>
                    <td style="padding: 12px; text-align: center; color: #ecf0f1; font-weight: 600; font-size: 1.1em;">
                        ${req.quantidade || 0}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${statusBadge}
                    </td>
                    <td style="padding: 12px; text-align: center; color: #bdc3c7; font-size: 0.9em;">
                        ${dataFormatada}
                    </td>
                    <td style="padding: 12px; text-align: center;">
                        ${actionsHTML}
                    </td>
                `;
                body.appendChild(tr);
            });
        }

        /**
         * Solicita ao usu√°rio informa√ß√µes para criar ou atualizar um item no
         * invent√°rio da fam√≠lia e envia a requisi√ß√£o para o servidor. Se um
         * item com a mesma categoria e subcategoria j√° existir, a quantidade
         * informada ser√° somada √† existente. Caso contr√°rio, um novo item
         * ser√° criado. Somente l√≠deres ou administradores chamam esta fun√ß√£o.
         */
        async function createOrUpdateItemFamilia() {
            const categoria = prompt('Informe a categoria do item (ex.: Produtos Comprados, Produtos de A√ß√£o, etc.):');
            if (!categoria) return;
            const item = prompt('Informe o nome do item (produto):');
            if (!item) return;
            const quantidadeStr = prompt('Informe a quantidade a adicionar:');
            const qtd = parseInt(quantidadeStr);
            if (isNaN(qtd) || qtd < 0) {
                alert('Quantidade inv√°lida');
                return;
            }
            const precoStr = prompt('Informe o pre√ßo unit√°rio (opcional, deixe em branco para manter):');
            const preco = precoStr ? parseFloat(precoStr) : null;
            try {
                const response = await fetch(`${API_BASE}/inventario-familia`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ categoria, item, quantidade: qtd, preco })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao atualizar invent√°rio');
                alert('Item atualizado com sucesso');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

        /**
         * Solicita ao usu√°rio informa√ß√µes para criar uma requisi√ß√£o de item e
         * envia a requisi√ß√£o para o servidor. Apenas membros ou gerentes
         * chamam esta fun√ß√£o. O usu√°rio escolhe um item pelo nome e a
         * quantidade desejada. Os dados do solicitante s√£o obtidos no
         * servidor.
         */
        async function createRequisicaoFamilia() {
            if (!inventarioFamilia || inventarioFamilia.length === 0) {
                alert('Nenhum item no invent√°rio dispon√≠vel para requisi√ß√£o');
                return;
            }
            // Constr√≥i uma lista de op√ß√µes para o prompt
            let itemList = 'Selecione o item desejado pelo n√∫mero:\n';
            inventarioFamilia.forEach((item, idx) => {
                itemList += `${idx + 1}. ${item.categoria} - ${item.item} (Qtd: ${item.quantidade})\n`;
            });
            const itemIndexStr = prompt(itemList);
            const index = parseInt(itemIndexStr) - 1;
            if (isNaN(index) || index < 0 || index >= inventarioFamilia.length) {
                alert('Item selecionado inv√°lido');
                return;
            }
            const quantidadeStr = prompt('Informe a quantidade desejada:');
            const qtd = parseInt(quantidadeStr);
            if (isNaN(qtd) || qtd <= 0) {
                alert('Quantidade inv√°lida');
                return;
            }
            const selectedItem = inventarioFamilia[index];
            try {
                const response = await fetch(`${API_BASE}/requisicoes-familia`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ item_id: selectedItem.id, quantidade: qtd })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao criar requisi√ß√£o');
                alert('Requisi√ß√£o criada com sucesso');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

        /**
         * Abre o modal para cadastro de um novo item no invent√°rio da fam√≠lia.
         * Pr√©-preenche os campos com valores vazios ou zero.
         */
        function openAddItemFamilia() {
            document.getElementById('addItemCategoria').value = '';
            document.getElementById('addItemNome').value = '';
            document.getElementById('addItemQuantidade').value = 0;
            document.getElementById('addItemPreco').value = '';
            document.getElementById('addItemMotivo').value = '';
            openModal('addItemFamiliaModal');
        }

        /**
         * Envia os dados do formul√°rio de item de invent√°rio para o servidor. Se
         * o item j√° existir para a mesma categoria, a quantidade ser√°
         * somada. Ap√≥s o sucesso, recarrega o invent√°rio.
         */
        async function submitAddItemFamilia() {
            const categoria = document.getElementById('addItemCategoria').value.trim();
            const itemNome = document.getElementById('addItemNome').value.trim();
            const qtdStr = document.getElementById('addItemQuantidade').value;
            const precoStr = document.getElementById('addItemPreco').value;
            const motivo = document.getElementById('addItemMotivo').value.trim();
            const quantidade = parseInt(qtdStr);
            const preco = precoStr !== '' ? parseFloat(precoStr) : null;
            if (!categoria || !itemNome || isNaN(quantidade) || quantidade < 0) {
                alert('Preencha todos os campos obrigat√≥rios corretamente');
                return;
            }
            if (!motivo) {
                alert('O motivo da altera√ß√£o √© obrigat√≥rio');
                return;
            }
            try {
                const response = await fetch(`${API_BASE}/inventario-familia`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ categoria, item: itemNome, quantidade, preco, motivo })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao salvar item');
                alert('Item cadastrado/atualizado com sucesso');
                closeModal('addItemFamiliaModal');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

        /**
         * Abre o modal para nova requisi√ß√£o. Preenche o seletor de usu√°rios e itens
         * com os dados dispon√≠veis e limpa os campos.
         */
        async function openNovaRequisicaoFamilia() {
            // Carrega lista de usu√°rios
            await loadUsuariosForRequisicao();
            
            // Limpa container de itens e adiciona primeira linha
            const container = document.getElementById('reqItensContainer');
            container.innerHTML = `
                <div class="req-item-row" style="display:grid; grid-template-columns: 2fr 1fr auto; gap:10px; margin-bottom:10px; align-items:end;">
                    <div>
                        <label>Item:<br>
                            <select class="req-item-select" style="width:100%; padding:4px;"></select>
                        </label>
                    </div>
                    <div>
                        <label>Quantidade:<br>
                            <input type="number" class="req-item-quantidade" min="1" value="1" style="width:100%; padding:4px;" required>
                        </label>
                    </div>
                    <div>
                        <button type="button" class="btn-secondary" onclick="removeReqItem(this)" style="padding:4px 8px;">Remover</button>
                    </div>
                </div>
            `;
            
            // Preenche todos os selects com itens do invent√°rio
            populateReqItemSelects();
            
            openModal('novaReqFamiliaModal');
        }

        /**
         * Carrega a lista de usu√°rios para o select de solicitante
         */
        async function loadUsuariosForRequisicao() {
            try {
                const response = await fetch(`${API_BASE}/membros`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    }
                });
                const data = await response.json();
                
                const select = document.getElementById('reqSolicitanteSelect');
                select.innerHTML = '<option value="">Selecione o solicitante...</option>';
                
                if (response.ok && data.length > 0) {
                    data.forEach(usuario => {
                        const option = document.createElement('option');
                        option.value = usuario.id;
                        option.textContent = `${usuario.nome} (${usuario.rg}) - ${usuario.telefone}`;
                        option.setAttribute('data-nome', usuario.nome);
                        option.setAttribute('data-rg', usuario.rg);
                        option.setAttribute('data-telefone', usuario.telefone);
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Erro ao carregar usu√°rios:', error);
                // Em caso de erro, permite digita√ß√£o manual
                const select = document.getElementById('reqSolicitanteSelect');
                select.innerHTML = '<option value="">Erro ao carregar usu√°rios</option>';
            }
        }

        /**
         * Preenche todos os selects de itens com o invent√°rio dispon√≠vel
         */
        function populateReqItemSelects() {
            const selects = document.querySelectorAll('.req-item-select');
            selects.forEach(select => {
                select.innerHTML = '<option value="">Selecione um item...</option>';
                if (inventarioFamilia && inventarioFamilia.length > 0) {
                    inventarioFamilia.forEach(it => {
                        const opt = document.createElement('option');
                        opt.value = it.id;
                        opt.textContent = `${it.categoria} - ${it.item} (Qtd: ${it.quantidade})`;
                        select.appendChild(opt);
                    });
                }
            });
        }

        /**
         * Adiciona uma nova linha de item √† requisi√ß√£o
         */
        function addReqItem() {
            const container = document.getElementById('reqItensContainer');
            const newRow = document.createElement('div');
            newRow.className = 'req-item-row';
            newRow.style.cssText = 'display:grid; grid-template-columns: 2fr 1fr auto; gap:10px; margin-bottom:10px; align-items:end;';
            newRow.innerHTML = `
                <div>
                    <label>Item:<br>
                        <select class="req-item-select" style="width:100%; padding:4px;"></select>
                    </label>
                </div>
                <div>
                    <label>Quantidade:<br>
                        <input type="number" class="req-item-quantidade" min="1" value="1" style="width:100%; padding:4px;" required>
                    </label>
                </div>
                <div>
                    <button type="button" class="btn-secondary" onclick="removeReqItem(this)" style="padding:4px 8px;">Remover</button>
                </div>
            `;
            container.appendChild(newRow);
            populateReqItemSelects();
        }

        /**
         * Remove uma linha de item da requisi√ß√£o
         */
        function removeReqItem(button) {
            const rows = document.querySelectorAll('.req-item-row');
            if (rows.length > 1) {
                button.closest('.req-item-row').remove();
            } else {
                alert('√â necess√°rio ter pelo menos um item na requisi√ß√£o');
            }
        }

        /**
         * Envia a requisi√ß√£o de itens para o servidor. Utiliza o usu√°rio selecionado
         * e os itens informados. Se houver sucesso, fecha o modal e recarrega a lista.
         */
        async function submitNovaRequisicaoFamilia() {
            // Validar solicitante
            const solicitanteSelect = document.getElementById('reqSolicitanteSelect');
            const solicitanteId = solicitanteSelect.value;
            
            if (!solicitanteId) {
                alert('Selecione o solicitante');
                return;
            }
            
            // Coletar itens selecionados
            const itemRows = document.querySelectorAll('.req-item-row');
            const itens = [];
            
            for (let row of itemRows) {
                const itemSelect = row.querySelector('.req-item-select');
                const quantidadeInput = row.querySelector('.req-item-quantidade');
                
                const itemId = itemSelect.value;
                const quantidade = parseInt(quantidadeInput.value);
                
                if (!itemId) {
                    alert('Selecione todos os itens');
                    return;
                }
                
                if (isNaN(quantidade) || quantidade <= 0) {
                    alert('Informe quantidades v√°lidas para todos os itens');
                    return;
                }
                
                itens.push({
                    item_id: parseInt(itemId),
                    quantidade: quantidade
                });
            }
            
            if (itens.length === 0) {
                alert('Adicione pelo menos um item √† requisi√ß√£o');
                return;
            }
            
            // Obter dados do usu√°rio selecionado
            const selectedOption = solicitanteSelect.options[solicitanteSelect.selectedIndex];
            const solicitanteNome = selectedOption.getAttribute('data-nome');
            const solicitanteRG = selectedOption.getAttribute('data-rg');
            const solicitanteTelefone = selectedOption.getAttribute('data-telefone');
            
            try {
                // Enviar cada item como uma requisi√ß√£o separada (mantendo compatibilidade com API existente)
                for (let item of itens) {
                    const response = await fetch(`${API_BASE}/requisicoes-familia`, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                            'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                        },
                        body: JSON.stringify({
                            item_id: item.item_id,
                            quantidade: item.quantidade,
                            solicitante_nome: solicitanteNome,
                            solicitante_rg: solicitanteRG,
                            solicitante_telefone: solicitanteTelefone
                        })
                    });
                    
                    const data = await response.json();
                    if (!response.ok) throw new Error(data.error || 'Erro ao criar requisi√ß√£o');
                }
                
                alert(`Requisi√ß√£o criada com sucesso! ${itens.length} item(ns) solicitado(s).`);
                closeModal('novaReqFamiliaModal');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

        // A√ß√µes de requisi√ß√µes: Aprovar, Rejeitar, Entregar, Cancelar
        async function aprovarRequisicao(id) {
            try {
                const res = await fetch(`${API_BASE}/requisicoes-familia/${id}/aprovar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao aprovar requisi√ß√£o');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }
        async function rejeitarRequisicao(id) {
            try {
                const res = await fetch(`${API_BASE}/requisicoes-familia/${id}/rejeitar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao rejeitar requisi√ß√£o');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }
        async function entregarRequisicao(id) {
            try {
                const res = await fetch(`${API_BASE}/requisicoes-familia/${id}/entregar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao entregar requisi√ß√£o');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }
        async function cancelarRequisicao(id) {
            try {
                const res = await fetch(`${API_BASE}/requisicoes-familia/${id}/cancelar`, {
                    method: 'PUT',
                    headers: { 'Authorization': `Bearer ${localStorage.getItem('authToken')}` }
                });
                const data = await res.json();
                if (!res.ok) throw new Error(data.error || 'Erro ao cancelar requisi√ß√£o');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

        /**
         * Abre o modal para adicionar estoque a um item existente.
         * Preenche os campos com as informa√ß√µes do item selecionado.
         */
        function openAdicionarEstoque(itemId, categoria, itemNome) {
            // Encontra o item no invent√°rio para obter a quantidade atual
            const item = inventarioFamilia.find(i => i.id === itemId);
            if (!item) {
                alert('Item n√£o encontrado');
                return;
            }
            
            // Preenche os campos do modal
            document.getElementById('estoqueItemNome').value = `${categoria} - ${itemNome}`;
            document.getElementById('estoqueQuantidadeAtual').value = item.quantidade;
            document.getElementById('estoqueQuantidadeAdicionar').value = 1;
            document.getElementById('estoqueMotivo').value = '';
            
            // Armazena o ID do item para usar na submiss√£o
            document.getElementById('adicionarEstoqueModal').setAttribute('data-item-id', itemId);
            
            openModal('adicionarEstoqueModal');
        }

        /**
         * Submete a adi√ß√£o de estoque para o servidor.
         * Utiliza a mesma API de cria√ß√£o/atualiza√ß√£o de item, passando a quantidade a ser adicionada.
         */
        async function submitAdicionarEstoque() {
            const modal = document.getElementById('adicionarEstoqueModal');
            const itemId = parseInt(modal.getAttribute('data-item-id'));
            const quantidadeAdicionar = parseInt(document.getElementById('estoqueQuantidadeAdicionar').value);
            const motivo = document.getElementById('estoqueMotivo').value.trim();
            
            if (isNaN(quantidadeAdicionar) || quantidadeAdicionar <= 0) {
                alert('Informe uma quantidade v√°lida para adicionar');
                return;
            }
            
            if (!motivo) {
                alert('O motivo da altera√ß√£o √© obrigat√≥rio');
                return;
            }
            
            // Encontra o item no invent√°rio
            const item = inventarioFamilia.find(i => i.id === itemId);
            if (!item) {
                alert('Item n√£o encontrado');
                return;
            }
            
            try {
                const response = await fetch(`${API_BASE}/inventario-familia`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('authToken')}`
                    },
                    body: JSON.stringify({ 
                        categoria: item.categoria, 
                        item: item.item, 
                        quantidade: quantidadeAdicionar,
                        preco: item.preco,
                        motivo: motivo
                    })
                });
                const data = await response.json();
                if (!response.ok) throw new Error(data.error || 'Erro ao adicionar estoque');
                alert(`Estoque adicionado com sucesso! ${quantidadeAdicionar} unidades adicionadas.`);
                closeModal('adicionarEstoqueModal');
                loadInventarioFamilia();
            } catch (error) {
                alert(error.message);
            }
        }

    </script>
</body>
</html>

